# 数据库保护部署指南

## 问题背景

之前的部署脚本会自动恢复备份数据库，这会覆盖生产环境中新导入的重要数据（如2025年车型数据）。

## 解决方案

现在部署脚本支持 `--keep-db` 参数，可以在部署时保护现有数据库不被覆盖。

## 使用方法

### 1. 保护数据库的部署命令

```bash
# 完整部署但保持数据库
sudo ./deploy.sh all --keep-db

# 前端部署并保持数据库  
sudo ./deploy.sh frontend --keep-db

# 后端部署并保持数据库
sudo ./deploy.sh backend --keep-db

# 使用简化脚本
sudo ./deploy-keep-db.sh
```

### 2. 传统部署（会恢复备份数据库）

```bash
# 完整部署（默认行为）
sudo ./deploy.sh

# 或明确指定
sudo ./deploy.sh all
```

## 部署日志示例

使用数据库保护功能时，你会看到：

```
🔒 数据库保护模式：将保持现有数据库，不恢复备份

步骤 7/12: 恢复数据库并同步表结构
🔒 保持现有数据库模式：跳过数据库恢复
✅ 使用现有数据库: 142 辆汽车, 141 辆摩托车
```

## 使用场景

### 何时使用 `--keep-db`：
- ✅ 已经导入了重要的新数据（如2025年车型）
- ✅ 生产环境数据库包含最新内容
- ✅ 只需要更新代码，不需要恢复旧数据
- ✅ 避免意外覆盖重要数据

### 何时使用传统部署：
- ❌ 需要从备份恢复数据库
- ❌ 生产环境数据库有问题需要重置
- ❌ 首次部署或完全重建环境

## 安全机制

1. **自动备份**：无论使用哪种模式，都会先备份当前数据库
2. **表结构同步**：即使保持数据库，也会同步必要的表结构
3. **数据验证**：显示保持的数据库中的记录数量
4. **回滚支持**：如有问题可以回滚到之前版本

## 文件说明

- `deploy.sh` - 主部署脚本（支持 --keep-db 参数）
- `deploy-keep-db.sh` - 简化的数据库保护部署脚本

## 示例场景

### 场景1：导入2025年数据后部署
```bash
# 1. 导入新数据
cd /var/www/vietnam-moto-auto/backend
node dist/scripts/import-complete-2025.js

# 2. 部署代码但保持数据库
cd /root/越南摩托汽车网站
sudo ./deploy.sh all --keep-db
```

### 场景2：只更新前端
```bash
# 更新前端代码但保持数据库
sudo ./deploy.sh frontend --keep-db
```

## 注意事项

- 使用 `--keep-db` 时，确保生产环境数据库是最新且正确的
- 如果生产环境数据库不存在，会自动使用开发环境数据库
- 数据库表结构仍会被同步，确保兼容性
- 备份文件会保留，可用于紧急恢复

---

**总结：现在可以安全地部署代码而不用担心覆盖重要的数据库数据！**
