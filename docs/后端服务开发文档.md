# 越南摩托汽车网站 - 后端服务开发文档

## 📋 文档概述

本文档详细记录越南摩托汽车网站后端服务的架构、API设计、数据模型、中间件和功能实现。

### 项目信息
- **运行环境**: Node.js 20+
- **Web框架**: Express.js 5.x
- **数据库**: SQLite 3.x
- **ORM**: Sequelize 6.x
- **语言**: TypeScript 5.x
- **缓存**: Redis 7.x（可选）
- **认证**: JWT

---

## 🏗️ 技术架构

### 1. 整体架构

```
┌─────────────────────────────────────────────────┐
│              客户端（前端）                       │
└─────────────────┬───────────────────────────────┘
                  │ HTTP/HTTPS
                  ↓
┌─────────────────────────────────────────────────┐
│            Nginx 反向代理                        │
│        (路由分发 + 静态资源)                     │
└─────────────────┬───────────────────────────────┘
                  │
                  ↓
┌─────────────────────────────────────────────────┐
│           Express.js 应用                        │
│  ┌──────────────────────────────────────────┐  │
│  │     中间件层 (Middleware Layer)          │  │
│  │  • CORS                                  │  │
│  │  • Helmet (安全头)                       │  │
│  │  • Rate Limiter (速率限制)               │  │
│  │  • Morgan (日志)                         │  │
│  │  • Body Parser                           │  │
│  └──────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────┐  │
│  │       路由层 (Route Layer)               │  │
│  │  • /api/news                             │  │
│  │  • /api/vehicles                         │  │
│  │  • /api/qa                               │  │
│  │  • /api/marketplace                      │  │
│  │  • /api/auth                             │  │
│  │  • /api/users                            │  │
│  └──────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────┐  │
│  │    控制器层 (Controller Layer)           │  │
│  │  • NewsController                        │  │
│  │  • VehicleController                     │  │
│  │  • QAController                          │  │
│  │  • MarketplaceController                 │  │
│  └──────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────┐  │
│  │    服务层 (Service Layer)                │  │
│  │  • 业务逻辑处理                          │  │
│  │  • 数据验证                              │  │
│  │  • 事务管理                              │  │
│  └──────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────┐  │
│  │     模型层 (Model Layer)                 │  │
│  │  • Sequelize Models                      │  │
│  │  • 数据验证规则                          │  │
│  └──────────────────────────────────────────┘  │
└─────────────────┬───────────────────────────────┘
                  │
        ┌─────────┴──────────┐
        ↓                    ↓
┌─────────────┐      ┌─────────────┐
│   SQLite    │      │    Redis    │
│   数据库    │      │    缓存     │
└─────────────┘      └─────────────┘
```

---

### 2. 目录结构

```
backend/
├── src/
│   ├── config/           # 配置文件
│   │   ├── database.ts       # 数据库配置
│   │   └── redis.ts          # Redis配置
│   │
│   ├── controllers/      # 控制器层
│   │   ├── NewsController.ts
│   │   └── MotorcycleController.ts
│   │
│   ├── models/           # 数据模型
│   │   ├── News.ts
│   │   └── Motorcycle.ts
│   │
│   ├── routes/           # 路由定义
│   │   ├── auth.ts
│   │   ├── news.ts
│   │   ├── vehicles.ts
│   │   ├── qa.ts
│   │   ├── marketplace.ts
│   │   ├── sitemap.ts        # ✨ SEO sitemap专用API
│   │   ├── users.ts
│   │   └── upload.ts
│   │
│   ├── services/         # 业务逻辑层
│   │   └── NewsService.ts
│   │
│   ├── middleware/       # 中间件
│   │   ├── errorHandler.ts
│   │   ├── notFound.ts
│   │   ├── auth.ts
│   │   └── validator.ts
│   │
│   ├── validators/       # 数据验证
│   │
│   ├── utils/            # 工具函数
│   │
│   ├── scripts/          # 脚本文件
│   │
│   └── index.ts          # 应用入口
│
├── database/             # 数据库文件
│   ├── vietnam_moto_auto.sqlite
│   └── init-database.js
│
├── uploads/              # 文件上传目录
├── logs/                 # 日志文件
├── dist/                 # 编译输出
├── tests/                # 测试文件
│
├── package.json
├── tsconfig.json
└── nodemon.json
```

---

## 🔧 核心配置

### 1. 环境变量

**文件**: `.env` 或 `.env.production`

```env
# 应用配置
NODE_ENV=production
PORT=4001
HOST=0.0.0.0

# 数据库配置（SQLite）
DB_TYPE=sqlite
DB_PATH=./database/vietnam_moto_auto.sqlite
DB_LOGGING=false

# Redis配置（可选）
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# JWT配置
JWT_SECRET=your-super-secret-jwt-key-change-in-production
JWT_EXPIRES_IN=7d

# 文件上传
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=10485760

# 日志配置
LOG_LEVEL=info
LOG_DIR=./logs

# CORS允许的源
ALLOWED_ORIGINS=http://localhost:4321,https://vietmoto.top
```

---

### 2. 数据库配置

**文件**: `src/config/database.ts`

```typescript
import { Sequelize } from 'sequelize';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config();

const {
  DB_PATH = path.join(__dirname, '../../database/vietnam_moto_auto.sqlite'),
  NODE_ENV = 'development'
} = process.env;

export const dbConfig = new Sequelize({
  dialect: 'sqlite',
  storage: DB_PATH,
  logging: NODE_ENV === 'development' ? console.log : false,
  pool: {
    max: 5,
    min: 0,
    acquire: 30000,
    idle: 10000,
  },
  define: {
    timestamps: true,
    underscored: true,
    freezeTableName: true,
  },
});

// 数据库连接测试
export const testConnection = async (): Promise<boolean> => {
  try {
    await dbConfig.authenticate();
    console.log('✅ Database connection established successfully.');
    return true;
  } catch (error) {
    console.error('❌ Unable to connect to the database:', error);
    return false;
  }
};
```

**特点**：
- 使用 SQLite 作为数据库
- 连接池配置
- 开发环境启用SQL日志
- 自动timestamps和下划线命名

---

### 3. Redis配置

**文件**: `src/config/redis.ts`

```typescript
import { createClient } from 'redis';

const redisConfig = createClient({
  url: `redis://${process.env.REDIS_HOST || 'localhost'}:${process.env.REDIS_PORT || 6379}`,
  database: parseInt(process.env.REDIS_DB || '0'),
});

redisConfig.on('error', (err) => {
  console.error('Redis Client Error:', err);
});

redisConfig.on('connect', () => {
  console.log('✅ Redis connected successfully');
});

export { redisConfig };
```

**用途**：
- 会话存储
- API响应缓存
- 速率限制计数
- 实时数据缓存

---

## 🌐 API 接口设计

### 1. 接口规范

#### 基础URL
- **开发环境**: `http://localhost:4001/api`
- **生产环境（域名+SSL）**: `https://vietmoto.top/api` ⭐ 推荐
- **生产环境（IP访问）**: `http://47.237.79.9:4001/api` ⚠️ 已弃用

**⚠️ 重要说明**：当前生产环境使用域名+SSL部署
- 前端通过相对路径 `/api` 调用API
- Nginx自动代理：`https://vietmoto.top/api/*` → `http://127.0.0.1:4001/*`
- 浏览器看到的都是HTTPS请求
- 不要在前端硬编码 `http://47.237.79.9:4001`

#### 请求格式
```
HTTP Method: GET | POST | PUT | DELETE
Content-Type: application/json
Authorization: Bearer <token>  (需要认证的接口)
```

#### 响应格式

**成功响应**：
```json
{
  "success": true,
  "message": "Operation successful",
  "data": { },
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 100,
    "totalPages": 10
  }
}
```

**错误响应**：
```json
{
  "success": false,
  "message": "Error description",
  "error": "Detailed error message",
  "code": "ERROR_CODE"
}
```

---

### 2. 新闻模块 API

**路由文件**: `src/routes/news.ts`

#### a) 创建新闻
```
POST /api/news
POST /api/news/webhook  (n8n webhook)
```

**请求体**（字段必须与数据库匹配）：
```json
{
  "title": "Honda Winner X 2024 ra mắt",
  "content": "<p>Nội dung chi tiết...</p>",
  "summary": "Tóm tắt ngắn",
  "category": "Xe máy",
  "author_name": "Nguyễn Văn A",
  "featured_image": "https://example.com/image.jpg",
  "status": "published"
}
```

**注意**：字段名必须使用：
- `featured_image`（不是 `cover_image`）
- `author_name`（不是 `author_id`）
- `summary`（可选）

**响应**：
```json
{
  "success": true,
  "message": "News created successfully",
  "data": {
    "id": 1,
    "title": "Honda Winner X 2024 ra mắt",
    "slug": "honda-winner-x-2024-ra-mat",
    "created_at": "2025-10-12T00:00:00.000Z"
  }
}
```

---

#### b) 获取新闻列表
```
GET /api/news
```

**查询参数**：
```
page=1              # 页码（默认1）
limit=10            # 每页数量（默认10）
category=Xe máy     # 分类筛选
status=published    # 状态筛选
is_featured=true    # 是否精选（注意：是is_featured，不是featured）
search=Honda        # 搜索关键词
```

**响应**：
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "title": "Honda Winner X 2024 ra mắt",
      "slug": "honda-winner-x-2024-ra-mat",
      "summary": "Tóm tắt...",
      "featured_image": "https://...",
      "category": "Xe máy",
      "view_count": 1250,
      "published_at": "2025-10-11T00:00:00.000Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 45,
    "totalPages": 5
  }
}
```

---

#### c) 获取新闻详情
```
GET /api/news/:id              # 通过ID获取
GET /api/news/slug/:slug       # 通过slug获取
```

**响应**：
```json
{
  "success": true,
  "data": {
    "id": 1,
    "title": "Honda Winner X 2024 ra mắt",
    "slug": "honda-winner-x-2024-ra-mat",
    "content": "<p>Nội dung đầy đủ...</p>",
    "summary": "Tóm tắt...",
    "featured_image": "https://...",
    "category": "Xe máy",
    "author_name": "Nguyễn Văn A",
    "view_count": 1251,
    "is_featured": false,
    "status": "published",
    "published_at": "2025-10-11T00:00:00.000Z",
    "created_at": "2025-10-11T00:00:00.000Z",
    "updated_at": "2025-10-12T00:00:00.000Z"
  }
}
```

---

#### d) 获取最新新闻
```
GET /api/news/latest?limit=6
```

---

#### e) 获取相关新闻
```
GET /api/news/slug/:slug/related?limit=4
```

---

#### f) 获取所有分类
```
GET /api/news/categories
```

**响应**：
```json
{
  "success": true,
  "data": [
    { "category": "Xe máy", "count": 25 },
    { "category": "Ô tô", "count": 30 },
    { "category": "Tin tức", "count": 15 }
  ]
}
```

---

#### g) 更新新闻
```
PUT /api/news/:id
```

**请求体**: 同创建新闻（字段可选）

---

#### h) 删除新闻
```
DELETE /api/news/:id
```

---

### 3. 车辆模块 API

**路由文件**: `src/routes/vehicles.ts`

#### a) 获取摩托车列表
```
GET /api/vehicles/motorcycles
```

**查询参数**：
```
page=1
limit=12
brand=Honda
category=Sport              # 注意：使用category，不是type
fuel_type=Gasoline
min_price=50000000
max_price=100000000
year=2024
status=active
search=Winner
```

**注意**：
- 使用 `category` 参数（不是 `type`）
- 价格筛选使用 `min_price` 和 `max_price`
- 所有字段名必须与数据库字段匹配

---

#### b) 获取摩托车详情
```
GET /api/vehicles/motorcycles/:id
```

---

#### c) 获取汽车列表
```
GET /api/vehicles/cars
```

**查询参数**：
```
page=1
limit=12
brand=Toyota
type=Sedan | SUV | MPV
min_price=500000000
max_price=1000000000
seats=5 | 7
fuel_type=Petrol | Diesel | Electric | Hybrid
transmission=Manual | Automatic
drive=FWD | RWD | AWD
```

---

#### d) 获取汽车详情
```
GET /api/vehicles/cars/:id
```

---

#### e) 获取品牌列表
```
GET /api/vehicles/brands?type=motorcycle | car
```

---

### 4. 问答模块 API

**路由文件**: `src/routes/qa.ts`

#### a) 获取问题列表
```
GET /api/qa/questions
```

**查询参数**：
```
page=1
limit=20
status=open | answered | closed
tag=maintenance | buying-guide
sort=latest | most_answered | most_liked
```

---

#### b) 获取问题详情
```
GET /api/qa/questions/:id
```

**响应包含**：
- 问题详情
- 所有回答（采纳答案置顶）
- 回答统计

---

#### c) 发布问题
```
POST /api/qa/questions
Authorization: Bearer <token>
```

**请求体**：
```json
{
  "title": "Honda Winner X 2024 có nên nâng cấp phanh ABS không?",
  "content": "Chi tiết câu hỏi...",
  "tags": ["Honda", "Winner X", "ABS", "Nâng cấp"]
}
```

---

#### d) 回答问题
```
POST /api/qa/questions/:id/answers
Authorization: Bearer <token>
```

**请求体**：
```json
{
  "content": "Nội dung trả lời..."
}
```

---

#### e) 投票（点赞/点踩）
```
POST /api/qa/answers/:id/vote
Authorization: Bearer <token>
```

**请求体**：
```json
{
  "vote_type": "up" | "down"
}
```

---

#### f) 采纳答案
```
POST /api/qa/answers/:id/accept
Authorization: Bearer <token>  (仅提问者)
```

---

### 5. 二手交易模块 API

**路由文件**: `src/routes/marketplace.ts`

#### a) 获取商品列表
```
GET /api/marketplace/listings
```

**查询参数**：
```
page=1
limit=12
type=motorcycle | car
brand=Honda
min_price=10000000
max_price=50000000
year_from=2020
year_to=2024
max_mileage=10000
condition=excellent | good | fair
location=Hà Nội | TP.HCM
sort=latest | price_asc | price_desc | mileage
```

---

#### b) 获取商品详情
```
GET /api/marketplace/listings/:id
```

---

#### c) 发布商品
```
POST /api/marketplace/listings
Authorization: Bearer <token>
```

---

### 6. Sitemap模块 API ✨ 新增

**路由文件**: `src/routes/sitemap.ts`

**说明**: Sitemap模块是专门为SEO优化设计的API端点，与普通API的主要区别：
- **只返回数据库数据**：不包含任何外部API数据
- **只返回有效状态**：仅返回active/published的记录
- **优化查询性能**：只查询必要字段（id, slug, lastmod）
- **固定数量限制**：每个端点最多返回1000条记录

#### a) 获取摩托车Sitemap数据
```
GET /api/sitemap/motorcycles
```

**响应示例**：
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "lastmod": "2025-10-14T10:30:00.000Z"
    }
  ]
}
```

**实现代码**：
```typescript
router.get('/motorcycles', asyncHandler(async (req: any, res: any) => {
  const motorcycles = await Motorcycle.findAll({
    where: { status: 'active' },
    attributes: ['id', 'updated_at', 'created_at'],
    limit: 1000,
  });

  res.json({
    success: true,
    data: motorcycles.map(m => ({
      id: m.id,
      lastmod: m.updated_at || m.created_at,
    })),
  });
}));
```

---

#### b) 获取汽车Sitemap数据
```
GET /api/sitemap/cars
```

**响应示例**：
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "slug": "toyota-vios-2024",
      "lastmod": "2025-10-14T10:30:00.000Z"
    }
  ]
}
```

---

#### c) 获取测评Sitemap数据
```
GET /api/sitemap/reviews
```

**查询条件**：
- `status = 'published'`
- `slug IS NOT NULL`（必须有slug才能生成URL）

---

#### d) 获取二手市场Sitemap数据
```
GET /api/sitemap/marketplace
```

**重要说明**：此端点与 `/api/marketplace` 的区别：
- `/api/marketplace`：返回数据库数据 + Chợ Tốt API外部数据（用于前端展示）
- `/api/sitemap/marketplace`：**只返回数据库数据**（用于SEO sitemap）

**为什么要分开**：
- 外部数据（Chợ Tốt）的商品在我们网站上没有对应页面
- 如果sitemap包含这些外部链接，Google会抓取到404错误
- 影响网站的SEO评分和索引质量

---

#### Sitemap API设计原则

1. **数据来源纯净**
   ```typescript
   // ✅ 正确：只查询数据库
   const data = await Model.findAll({ where: { status: 'active' } });
   
   // ❌ 错误：混合外部API数据
   const dbData = await Model.findAll();
   const externalData = await fetchFromExternalAPI();
   return [...dbData, ...externalData];
   ```

2. **最小化查询字段**
   ```typescript
   // ✅ 正确：只查询需要的字段
   attributes: ['id', 'slug', 'updated_at', 'created_at']
   
   // ❌ 错误：查询所有字段（浪费资源）
   // 不指定attributes会查询所有字段
   ```

3. **严格的状态过滤**
   ```typescript
   // ✅ 正确：只返回有效数据
   where: { 
     status: 'published',
     slug: { [Op.ne]: null }
   }
   
   // ❌ 错误：返回所有数据（包括草稿、删除的）
   where: {}
   ```

4. **合理的数量限制**
   ```typescript
   // ✅ 正确：限制数量，防止过载
   limit: 1000
   
   // ❌ 错误：无限制（可能导致性能问题）
   // 不设置limit
   ```

**请求体**：
```json
{
  "title": "Honda Winner X 2023 zin 100%, chạy 5000km",
  "description": "Mô tả chi tiết...",
  "vehicle_type": "motorcycle",
  "brand": "Honda",
  "model": "Winner X",
  "year": 2023,
  "mileage": 5000,
  "price": 42000000,
  "condition": "excellent",
  "location": "Hà Nội",
  "images": ["url1", "url2", "url3"],
  "tags": ["Chính chủ", "Bao test", "Có sẵn"]
}
```

---

#### d) 更新商品
```
PUT /api/marketplace/listings/:id
Authorization: Bearer <token>  (仅所有者)
```

---

#### e) 删除商品
```
DELETE /api/marketplace/listings/:id
Authorization: Bearer <token>  (仅所有者)
```

---

### 6. 用户认证 API

**路由文件**: `src/routes/auth.ts`

#### a) 用户注册
```
POST /api/auth/register
```

**请求体**：
```json
{
  "username": "nguyenvana",
  "email": "nguyenvana@example.com",
  "password": "SecurePassword123!",
  "full_name": "Nguyễn Văn A",
  "phone": "0912345678"
}
```

---

#### b) 用户登录
```
POST /api/auth/login
```

**请求体**：
```json
{
  "email": "nguyenvana@example.com",
  "password": "SecurePassword123!"
}
```

**响应**：
```json
{
  "success": true,
  "message": "Login successful",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "uuid-123",
      "username": "nguyenvana",
      "email": "nguyenvana@example.com",
      "full_name": "Nguyễn Văn A",
      "role": "user"
    }
  }
}
```

---

#### c) 获取当前用户
```
GET /api/users/me
Authorization: Bearer <token>
```

---

#### d) 刷新Token
```
POST /api/auth/refresh
Authorization: Bearer <refresh_token>
```

---

### 7. 文件上传 API

**路由文件**: `src/routes/upload.ts`

#### a) 上传单个文件
```
POST /api/upload/single
Authorization: Bearer <token>
Content-Type: multipart/form-data
```

**表单数据**：
```
file: <binary file>
type: image | document | video
```

**响应**：
```json
{
  "success": true,
  "data": {
    "url": "/uploads/images/2025/10/filename.jpg",
    "filename": "filename.jpg",
    "size": 245678,
    "mimetype": "image/jpeg"
  }
}
```

---

#### b) 上传多个文件
```
POST /api/upload/multiple
Authorization: Bearer <token>
Content-Type: multipart/form-data
```

**表单数据**：
```
files[]: <binary file 1>
files[]: <binary file 2>
files[]: <binary file 3>
```

---

## 📦 数据模型

### 1. News Model (新闻模型)

**文件**: `src/models/News.ts`

**字段定义**（匹配生产环境数据库）：
```typescript
interface NewsAttributes {
  id: number;                    // 主键（自增）
  title: string;                 // 标题（必填）
  slug: string;                  // URL友好标识（唯一）
  content: string;               // 内容（必填）
  summary?: string;              // 摘要
  excerpt?: string;              // 简短摘要（从summary提取）
  featured_image?: string;       // 特色图片URL
  category?: string;             // 分类
  author_name?: string;          // 作者名称
  status: string;                // 状态（draft/published/archived）
  is_featured: boolean;          // 是否精选（布尔值）
  view_count: number;            // 浏览次数
  published_at?: Date;           // 发布时间
  created_at: Date;              // 创建时间
  updated_at: Date;              // 更新时间
}
```

**验证规则**：
- `title`: 非空
- `slug`: 唯一，非空
- `content`: 非空
- `is_featured`: 布尔值，默认false
- `view_count`: 整数，默认0

**索引**：
- PRIMARY KEY: `id`
- UNIQUE: `slug`
- INDEX: `category`, `status`, `is_featured`, `published_at`

**重要说明**：
- 字段名使用 `is_featured`（不是 `featured`）
- 字段名使用 `view_count`（不是 `views`）
- 字段名使用 `featured_image`（不是 `cover_image`）
- 字段名使用 `author_name`（不是 `author_id`）

---

### 2. Motorcycle Model (摩托车模型)

**文件**: `src/models/Motorcycle.ts`

**字段定义**（匹配生产环境数据库，共52个字段）：
```typescript
interface MotorcycleAttributes {
  id: number;                    // 主键（自增）
  brand: string;                 // 品牌
  model: string;                 // 型号
  year: number;                  // 年份
  category: string;              // 类型分类
  price_vnd: number;             // 价格（越南盾）
  
  // 发动机系统
  engine_cc?: number;            // 排量(cc)
  engine_type?: string;          // 引擎类型
  power_hp?: number;             // 最大功率(HP)
  power_rpm?: number;            // 功率转速
  torque_nm?: number;            // 最大扭矩(Nm)
  torque_rpm?: number;           // 扭矩转速
  compression_ratio?: string;    // 压缩比
  bore_stroke?: string;          // 缸径×行程
  valve_system?: string;         // 配气机构
  
  // 传动系统
  transmission?: string;         // 变速箱
  clutch_type?: string;          // 离合器类型
  fuel_type?: string;            // 燃料类型
  fuel_supply?: string;          // 供油方式
  starter?: string;              // 启动方式
  ignition?: string;             // 点火方式
  
  // 电动车参数
  battery_kwh?: number;          // 电池容量(kWh)
  range_km?: number;             // 续航里程(km)
  charge_time_h?: number;        // 充电时间(小时)
  
  // 底盘系统
  frame_type?: string;           // 车架类型
  front_suspension?: string;     // 前悬挂
  rear_suspension?: string;      // 后悬挂
  front_brake?: string;          // 前制动
  rear_brake?: string;           // 后制动
  front_tire?: string;           // 前轮胎
  rear_tire?: string;            // 后轮胎
  
  // 尺寸重量
  dimensions_mm?: string;        // 尺寸(mm)
  wheelbase_mm?: number;         // 轴距(mm)
  ground_clearance_mm?: number;  // 离地间隙(mm)
  seat_height_mm?: number;       // 座高(mm)
  weight_kg?: number;            // 整车重量(kg)
  fuel_capacity_l?: number;      // 油箱容量(L)
  
  // 配置信息
  abs: boolean;                  // 是否有ABS
  smart_key: boolean;            // 是否有智能钥匙
  display_type?: string;         // 仪表类型
  lighting?: string;             // 灯光配置
  features?: string;             // 特色功能
  
  // 其他信息
  description?: string;          // 描述
  warranty?: string;             // 质保
  fuel_consumption?: string;     // 油耗
  colors?: string;               // 颜色
  image_url?: string;            // 图片URL
  rating?: number;               // 评分
  view_count: number;            // 浏览次数
  status: string;                // 状态
  created_at: Date;              // 创建时间
  updated_at: Date;              // 更新时间
}
```

**重要说明**：
- 字段名使用 `category`（不是 `type`）
- 字段名使用 `view_count`（不是 `views`）
- 字段名使用 `price_vnd`（不是 `price` 或 `official_price`）
- 包含 `abs` 和 `smart_key` 布尔字段
- 发动机、传动、底盘等系统字段齐全
- 总共52个字段，涵盖摩托车所有详细参数

---

### 3. User Model (用户模型)

**字段定义**：
```typescript
interface UserAttributes {
  id: string;                    // UUID
  username: string;              // 用户名（唯一）
  email: string;                 // 邮箱（唯一）
  password_hash: string;         // 密码哈希
  full_name?: string;            // 真实姓名
  phone?: string;                // 手机号
  avatar?: string;               // 头像URL
  bio?: string;                  // 个人简介
  role: 'user' | 'moderator' | 'admin';  // 角色
  reputation_points: number;     // 声望积分
  verified: boolean;             // 是否认证
  status: 'active' | 'suspended' | 'deleted';  // 账号状态
  last_login?: Date;             // 最后登录
  created_at: Date;
  updated_at: Date;
}
```

**安全措施**：
- 密码使用 bcrypt 加密
- 密码不返回给客户端
- JWT token 认证

---

## 🎯 控制器层

### 1. NewsController

**文件**: `src/controllers/NewsController.ts`

**方法列表**：

```typescript
class NewsController {
  // 创建新闻
  static async create(req: Request, res: Response): Promise<void>
  
  // 获取新闻列表（带分页、筛选）
  static async getList(req: Request, res: Response): Promise<void>
  
  // 通过slug获取新闻详情
  static async getBySlug(req: Request, res: Response): Promise<void>
  
  // 通过ID获取新闻详情
  static async getById(req: Request, res: Response): Promise<void>
  
  // 获取最新新闻
  static async getLatest(req: Request, res: Response): Promise<void>
  
  // 获取相关新闻
  static async getRelated(req: Request, res: Response): Promise<void>
  
  // 获取所有分类
  static async getCategories(req: Request, res: Response): Promise<void>
  
  // 更新新闻
  static async update(req: Request, res: Response): Promise<void>
  
  // 删除新闻
  static async delete(req: Request, res: Response): Promise<void>
}
```

**实现示例**：
```typescript
static async create(req: Request, res: Response): Promise<void> {
  try {
    const { title, content, summary, category } = req.body;

    // 验证必填字段
    if (!title || !content) {
      res.status(400).json({
        success: false,
        message: 'Title and content are required',
      });
      return;
    }

    // 调用Service层
    const news = await NewsService.createNews({
      title,
      content,
      summary,
      category,
    });

    res.status(201).json({
      success: true,
      message: 'News created successfully',
      data: news,
    });
  } catch (error: any) {
    console.error('创建新闻失败:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to create news',
      error: error.message,
    });
  }
}
```

**职责**：
- 请求参数验证
- 调用Service层处理业务逻辑
- 响应格式化
- 错误处理

---

## 🧩 服务层

### 1. NewsService

**文件**: `src/services/NewsService.ts`

**方法列表**：

```typescript
class NewsService {
  // 创建新闻
  static async createNews(data: NewsCreationData): Promise<News>
  
  // 获取新闻列表（带分页筛选）
  static async getNewsList(options: NewsListOptions): Promise<NewsListResult>
  
  // 通过slug获取新闻
  static async getNewsBySlug(slug: string): Promise<News | null>
  
  // 增加浏览次数
  static async incrementViewCount(newsId: number): Promise<void>
  
  // 获取相关新闻
  static async getRelatedNews(newsId: number, limit: number): Promise<News[]>
  
  // 生成slug
  static generateSlug(title: string): string
}
```

**业务逻辑示例**：
```typescript
static async createNews(data: NewsCreationData): Promise<News> {
  // 生成slug
  const slug = this.generateSlug(data.title);
  
  // 自动提取摘要（如果没有提供）
  const excerpt = data.excerpt || this.extractExcerpt(data.content);
  
  // 设置发布时间
  const published_at = data.status === 'published' 
    ? new Date() 
    : null;
  
  // 创建新闻
  const news = await News.create({
    ...data,
    slug,
    excerpt,
    published_at,
    view_count: 0,
    is_featured: data.is_featured || false,
  });
  
  // 清除缓存
  await this.clearNewsCache();
  
  return news;
}

static generateSlug(title: string): string {
  return title
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')  // 移除音调符号
    .replace(/[^a-z0-9\s-]/g, '')
    .trim()
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-');
}
```

**职责**：
- 核心业务逻辑
- 数据验证和转换
- 数据库操作
- 缓存管理
- 复杂计算

---

## 🛡️ 中间件

### 1. 错误处理中间件

**文件**: `src/middleware/errorHandler.ts`

```typescript
// 异步错误处理包装器
export const asyncHandler = (fn: Function) => {
  return (req: Request, res: Response, next: NextFunction) => {
    Promise.resolve(fn(req, res, next)).catch(next);
  };
};

// 全局错误处理器
export const errorHandler = (
  err: any,
  req: Request,
  res: Response,
  next: NextFunction
) => {
  console.error('Error:', err);

  const statusCode = err.statusCode || 500;
  const message = err.message || 'Internal Server Error';

  res.status(statusCode).json({
    success: false,
    message,
    error: process.env.NODE_ENV === 'development' ? err.stack : undefined,
  });
};
```

---

### 2. 404处理中间件

**文件**: `src/middleware/notFound.ts`

```typescript
export const notFound = (req: Request, res: Response) => {
  res.status(404).json({
    success: false,
    message: `Route not found: ${req.method} ${req.originalUrl}`,
  });
};
```

---

### 3. 认证中间件

**文件**: `src/middleware/auth.ts`

```typescript
import jwt from 'jsonwebtoken';

export const authenticate = async (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  try {
    const token = req.headers.authorization?.replace('Bearer ', '');

    if (!token) {
      return res.status(401).json({
        success: false,
        message: 'No token provided',
      });
    }

    const decoded = jwt.verify(token, process.env.JWT_SECRET!);
    req.user = decoded;
    next();
  } catch (error) {
    res.status(401).json({
      success: false,
      message: 'Invalid token',
    });
  }
};

// 角色检查
export const authorize = (...roles: string[]) => {
  return (req: Request, res: Response, next: NextFunction) => {
    if (!req.user || !roles.includes(req.user.role)) {
      return res.status(403).json({
        success: false,
        message: 'Insufficient permissions',
      });
    }
    next();
  };
};
```

---

### 4. 数据验证中间件

**文件**: `src/middleware/validator.ts`

使用 `express-validator`:

```typescript
import { validationResult } from 'express-validator';

export const validate = (req: Request, res: Response, next: NextFunction) => {
  const errors = validationResult(req);
  
  if (!errors.isEmpty()) {
    return res.status(400).json({
      success: false,
      message: 'Validation errors',
      errors: errors.array(),
    });
  }
  
  next();
};
```

---

## 🔒 安全措施

### 1. Helmet 安全头
```typescript
app.use(helmet({
  crossOriginEmbedderPolicy: false,
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"],
    },
  },
}));
```

---

### 2. CORS 配置

**⚠️ 生产环境配置（域名+SSL）**：
```typescript
const allowedOrigins = [
  'http://localhost:4321',       // 开发环境
  'https://vietmoto.top',        // 生产环境（域名+SSL）⭐
  'http://47.237.79.9:4321',     // 备用（已弃用）
  'http://127.0.0.1:4321'        // 本地测试
];

app.use(cors({
  origin: (origin, callback) => {
    // 允许无origin的请求（如服务端调用、Postman等）
    if (!origin) return callback(null, true);
    
    if (allowedOrigins.indexOf(origin) !== -1) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization'],
}));
```

**说明**：
- 生产环境必须包含 `https://vietmoto.top`
- 不再需要 `http://47.237.79.9:4321`（前端通过Nginx代理，origin是域名）
- 前端请求origin自动为 `https://vietmoto.top`

---

### 3. 速率限制
```typescript
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000,  // 15分钟
  max: 100,                  // 最多100个请求
  message: {
    error: 'Too many requests, please try again later.',
  },
  standardHeaders: true,
  legacyHeaders: false,
});

app.use('/api/', limiter);
```

---

### 4. SQL注入防护
- 使用 Sequelize ORM
- 参数化查询
- 输入验证和清理

---

### 5. XSS防护
- 输入清理
- Content-Security-Policy头
- 输出转义

---

## 📝 日志系统

### 1. Morgan HTTP日志
```typescript
app.use(morgan('combined'));
```

日志格式：
```
::1 - - [12/Oct/2025:00:00:00 +0000] "GET /api/news HTTP/1.1" 200 1234 "-" "Mozilla/5.0..."
```

---

### 2. 自定义日志

**建议使用 Winston**:

```typescript
import winston from 'winston';

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
    new winston.transports.File({ filename: 'logs/combined.log' }),
  ],
});

if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.simple(),
  }));
}

export default logger;
```

---

## 🧪 测试

### 1. 单元测试

使用 Jest:

```typescript
// tests/services/NewsService.test.ts
import NewsService from '../../src/services/NewsService';

describe('NewsService', () => {
  describe('generateSlug', () => {
    it('应该正确生成slug', () => {
      const slug = NewsService.generateSlug('Honda Winner X 2024 ra mắt');
      expect(slug).toBe('honda-winner-x-2024-ra-mat');
    });
  });

  describe('createNews', () => {
    it('应该成功创建新闻', async () => {
      const newsData = {
        title: 'Test News',
        content: 'Test content',
      };
      
      const news = await NewsService.createNews(newsData);
      expect(news).toHaveProperty('id');
      expect(news.slug).toBe('test-news');
    });
  });
});
```

---

### 2. API测试

使用 Supertest:

```typescript
// tests/api/news.test.ts
import request from 'supertest';
import app from '../../src/index';

describe('News API', () => {
  describe('GET /api/news', () => {
    it('应该返回新闻列表', async () => {
      const response = await request(app)
        .get('/api/news')
        .expect('Content-Type', /json/)
        .expect(200);

      expect(response.body.success).toBe(true);
      expect(response.body.data).toBeInstanceOf(Array);
    });
  });

  describe('POST /api/news', () => {
    it('应该创建新闻', async () => {
      const newsData = {
        title: 'Test News',
        content: 'Test content',
      };

      const response = await request(app)
        .post('/api/news')
        .send(newsData)
        .expect(201);

      expect(response.body.success).toBe(true);
      expect(response.body.data).toHaveProperty('id');
    });
  });
});
```

---

## 🚀 部署与运维

### 1. 编译 TypeScript
```bash
npm run build
```

输出目录: `dist/`

---

### 2. 启动生产服务器
```bash
# 使用 Node.js
npm start

# 使用 Systemd（推荐）
sudo systemctl start vietnam-moto-backend
```

---

### 3. 健康检查

**开发环境**：
```bash
curl http://localhost:4001/health
```

**生产环境（域名+SSL）**：
```bash
# 通过域名访问（推荐）
curl https://vietmoto.top/api/health

# 直接访问后端（内网）
curl http://localhost:4001/health
```

响应:
```json
{
  "status": "OK",
  "timestamp": "2025-10-14T00:00:00.000Z",
  "uptime": 12345,
  "environment": "production"
}
```

**说明**：
- 生产环境推荐通过域名访问，测试完整的HTTPS + Nginx代理链路
- 直接访问 `localhost:4001` 只测试后端服务本身

**⚠️ SSR环境特别说明（2025-10-14）**：
- Astro SSR页面在服务器端执行时，必须使用完整URL：`http://localhost:4001/api`
- 无法使用相对路径 `/api`，因为服务器端没有域名上下文
- 客户端JavaScript可以使用相对路径，通过Nginx代理

---

### 4. 监控和日志
```bash
# 查看服务状态
sudo systemctl status vietnam-moto-backend

# 查看实时日志
sudo journalctl -u vietnam-moto-backend -f

# 查看应用日志
tail -f logs/combined.log
```

---

## 📚 开发规范

### 1. 代码风格
- 使用 TypeScript 严格模式
- ESLint + Prettier
- 驼峰命名法（camelCase）
- 接口使用 PascalCase

---

### 2. 提交规范
```
feat: 新增功能
fix: 修复bug
docs: 文档更新
refactor: 代码重构
test: 测试相关
chore: 构建/工具链
```

---

### 3. 注释规范
```typescript
/**
 * 创建新闻
 * @param data 新闻数据
 * @returns 创建的新闻对象
 * @throws {ValidationError} 验证失败时抛出
 */
static async createNews(data: NewsCreationData): Promise<News> {
  // 实现代码
}
```

---

## 🔗 相关文档

- [README.md](./README.md) - 项目总览
- [数据库设计文档.md](./数据库设计文档.md) - 数据库详细设计
- [前端页面设计开发文档.md](./前端页面设计开发文档.md) - 前端开发文档
- [生产环境部署文档.md](./生产环境部署文档.md) - 部署说明

---

## 📞 技术支持

如有后端开发相关问题，请参考：
- Express.js 文档: https://expressjs.com
- Sequelize 文档: https://sequelize.org
- TypeScript 文档: https://www.typescriptlang.org

---

---

## 📝 更新日志

### v2.2.0 (2025年10月14日 下午)
**Sitemap模块新增**
- ✅ 新增Sitemap专用API模块（4个端点）
- ✅ 添加sitemap路由文件说明
- ✅ 完善Sitemap API设计原则
- ✅ 区分普通API和Sitemap API的用途
- ✅ 添加数据来源纯净性保证
- ✅ 优化SEO sitemap数据质量

### v2.1.0 (2025年10月14日 下午)
**SSR环境API调用修复**
- ✅ 添加SSR环境特别说明
- ✅ 区分服务器端和客户端API调用方式
- ✅ 修复详情页SSR渲染问题
- ✅ 更新CORS配置示例
- ✅ 完善健康检查说明

### v2.0.0 (2025年10月14日 上午)
**生产环境：域名+SSL部署更新**
- ✅ 更新API基础URL：增加域名+SSL配置说明
- ✅ 更新环境变量：ALLOWED_ORIGINS 包含 `https://vietmoto.top`
- ✅ 更新CORS配置：支持HTTPS域名访问
- ✅ 更新健康检查：提供域名和内网两种方式
- ✅ 添加前端API调用规范说明
- ✅ 强调不要硬编码HTTP地址和使用环境变量

### v1.0.0 (2025年10月12日)
- 初始版本发布
- 完整的后端API文档
- 数据模型定义
- 中间件和安全措施

---

**文档版本**: v2.2.0  
**最后更新**: 2025年10月14日  
**维护者**: 后端开发团队

