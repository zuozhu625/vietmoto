# 生产环境部署文档

## 📋 概述

本文档详细说明越南摩托汽车资讯网站的生产环境部署流程、部署脚本使用方法和常见问题解决方案。

---

## 🚀 快速部署

### 一键部署（推荐）

```bash
cd /root/越南摩托汽车网站
sudo bash ./deploy.sh
```

**特点：**
- ✅ 全自动部署流程（12个步骤）
- ✅ 三重数据库保护机制
- ✅ 自动回滚功能
- ✅ 完整的验证检查
- ✅ 详细的日志输出

---

## 📦 部署脚本列表

本项目提供了多个部署脚本，适用于不同的部署场景。

### 1. **pre-deploy-check.sh** - 部署前检查 ⭐ 推荐先运行

**路径**：`/root/越南摩托汽车网站/pre-deploy-check.sh`

**用途**：在实际部署前检查所有依赖和配置

**检查项目**：
- ✅ 系统命令（node, npm, sqlite3, nginx等）
- ✅ Node.js 版本（>= 18）
- ✅ 项目目录结构
- ✅ 配置文件完整性
- ✅ 开发环境数据库（表结构、数据量）
- ✅ 生产环境数据库（如存在）
- ✅ 数据库同步脚本
- ✅ 磁盘空间

**使用方法**：
```bash
cd /root/越南摩托汽车网站
./pre-deploy-check.sh
```

**输出示例**：
```
✅ 所有检查通过！可以开始部署
  - 摩托车: 126 条
  - 汽车: 124 条
  - 二手交易: 0 条
  - 问答: 11 条
```

---

### 2. **quick-deploy.sh** - 快速部署 ⚡ 推荐日常使用

**路径**：`/root/越南摩托汽车网站/quick-deploy.sh`

**用途**：快速部署单个模块，不进行完整备份

**特点**：
- ⚡ 只编译和部署指定模块
- 💾 不创建完整备份（速度快）
- 🎯 适合日常小改动
- ✅ 自动健康检查

**使用方法**：
```bash
# 只部署前端（约20秒）
sudo ./quick-deploy.sh frontend

# 只部署后端（约15秒）
sudo ./quick-deploy.sh backend
```

**流程（前端）**：
1. 构建前端（npm run build）
2. 复制文件到生产环境
3. 重启前端服务
4. 健康检查

**流程（后端）**：
1. 编译 TypeScript（npm run build）
2. 复制文件到生产环境
3. 安装生产依赖
4. 重启后端服务
5. 健康检查

**注意事项**：
- ✅ 已修复 Astro hybrid 模式构建检查
- ✅ 支持 dist/client 和 dist/server 结构
- ✅ 自动禁用代理进行健康检查

---

### 3. **deploy.sh** - 完整部署 🎯 大版本更新

**路径**：`/root/越南摩托汽车网站/deploy.sh`

**用途**：生产环境完整部署脚本（v3.1.0）

**核心特性：**
- ✅ **三重数据库保护**
  - 临时备份（用于立即恢复）
  - 永久备份（gzip压缩归档到 `/backup/database/`）
  - 完整回滚备份（整个项目快照）
  
- ✅ **自动回滚机制**
  - 任何步骤失败自动回滚到上一版本
  - 使用 `trap` 捕获所有错误
  - 保护生产环境稳定性

- ✅ **完整的验证检查**
  - 部署前：权限、环境、数据库完整性
  - 部署中：编译结果、构建产物
  - 部署后：服务健康检查、API测试

- ✅ **数据库表结构自动同步** (v3.1.0 新增)
  - 自动运行 sync-dev-to-prod.sql
  - 验证 marketplace_vehicles 和 reviews 表
  - 确保开发和生产环境一致

- ✅ **不依赖外部工具**
  - 使用系统内置的 `tar` 命令
  - 无需安装 `rsync`

**部署流程（12个步骤）：**
```
步骤 1/12: 权限检查
步骤 2/12: 环境检查（tar, node, npm, sqlite3, nginx, systemctl）
步骤 3/12: 数据库安全备份（含完整性检查）
步骤 4/12: 完整备份当前版本（用于回滚）
步骤 5/12: 准备目标目录
步骤 6/12: 复制项目文件（tar排除数据库）
步骤 7/12: 恢复数据库并同步表结构 ⭐ v3.1.0 增强
步骤 8/12: 安装后端依赖
步骤 9/12: 编译 TypeScript
步骤 10/12: 构建前端（Astro Hybrid模式）⭐ v3.1.0 修复
步骤 11/12: 配置生产环境
步骤 12/12: 启动服务
```

**使用方法**：
```bash
# 完整部署（推荐）
cd /root/越南摩托汽车网站
sudo bash ./deploy.sh

# 或指定模式
sudo ./deploy.sh all        # 完整部署（默认）
sudo ./deploy.sh frontend   # 只部署前端（但会备份）
sudo ./deploy.sh backend    # 只部署后端（但会备份）
sudo ./deploy.sh config     # 只更新配置
```

**重要更新（v3.1.0）**：
- ✅ 修复前端构建检查（支持 Astro Hybrid 模式）
- ✅ 新增数据库表结构自动同步
- ✅ 自动验证关键表（marketplace_vehicles、reviews）
- ✅ 修正开发环境数据库路径
- ✅ 完善错误处理和回滚机制

**部署输出**：
- 彩色日志输出（蓝色=信息，绿色=成功，黄色=警告，红色=错误）
- 实时进度反馈
- 每个步骤的详细状态

**部署完成后**：
- 显示访问地址
- 列出常用管理命令
- 提供重要文件路径
- 显示回滚备份位置

---

### 📊 部署流程对比

| 特性 | pre-deploy-check | quick-deploy | deploy |
|------|-----------------|--------------|--------|
| **检查依赖** | ✅ | ❌ | ✅ |
| **数据库备份** | ❌ | ❌ | ✅ |
| **表结构同步** | ❌ | ❌ | ✅ |
| **完整备份** | ❌ | ❌ | ✅ |
| **失败回滚** | ❌ | ❌ | ✅ |
| **健康检查** | ❌ | ✅ | ✅ |
| **执行速度** | 快（几秒） | 快（15-20秒） | 慢（2-3分钟） |
| **适用场景** | 部署前检查 | 日常小更新 | 大版本更新 |

### 🎯 使用建议

**首次部署：**
```bash
# 1. 先检查环境
./pre-deploy-check.sh

# 2. 完整部署
sudo ./deploy.sh
```

**日常开发：**
```bash
# 1. 检查环境（可选）
./pre-deploy-check.sh

# 2. 快速部署
sudo ./quick-deploy.sh frontend  # 只部署前端
sudo ./quick-deploy.sh backend   # 或只部署后端
```

**大版本更新：**
```bash
# 1. 必须先检查
./pre-deploy-check.sh

# 2. 完整部署（带备份和回滚）
sudo ./deploy.sh
```

### 🔧 已修复的关键问题 (v3.1.0)

#### 问题 1: 前端构建检查失败
**原因**：Astro hybrid 模式生成 `dist/client` 和 `dist/server`，而不是 `dist/index.html`

**修复**：
```bash
# 修复前
if [ ! -f "dist/index.html" ]; then
    log_error "构建失败"
fi

# 修复后
if [ ! -d "dist/client" ] && [ ! -d "dist/server" ] && [ ! -f "dist/index.html" ]; then
    log_error "构建失败"
fi
```

**影响脚本**：`quick-deploy.sh`、`deploy.sh`

#### 问题 2: 数据库表结构不同步
**原因**：新增的 `marketplace_vehicles` 和 `reviews` 表在部署时未自动创建

**修复**：在 `deploy.sh` 的步骤 7 中新增表结构同步
```bash
# 同步数据库表结构
if [ -f "$SOURCE_DIR/backend/database/sync-dev-to-prod.sql" ]; then
    sqlite3 "$TARGET_DIR/$DB_FILE" < "$SOURCE_DIR/backend/database/sync-dev-to-prod.sql"
    log_success "数据库表结构已同步"
fi

# 验证关键表
if echo "$TABLES" | grep -q "marketplace_vehicles"; then
    log_success "✅ marketplace_vehicles 表存在"
else
    log_warning "⚠️  marketplace_vehicles 表不存在"
fi
```

#### 问题 3: 开发环境数据库路径错误
**原因**：路径硬编码为 `backend/vietnam_moto_auto.sqlite`，实际为 `backend/database/vietnam_moto_auto.sqlite`

**修复**：
```bash
# 修复前
SOURCE_DIR/backend/vietnam_moto_auto.sqlite

# 修复后
SOURCE_DIR/backend/database/vietnam_moto_auto.sqlite
```

---

### 4. **backup-database.sh** （数据库备份）

**路径**：`/root/越南摩托汽车网站/backup-database.sh`

**用途**：SQLite 数据库备份脚本

**特点**：
- ✅ 自动备份 SQLite 数据库
- ✅ 自动压缩备份文件（gzip）
- ✅ 自动清理旧备份（保留30天）
- ✅ 验证备份完整性
- ✅ 显示备份统计信息

**使用方法**：
```bash
cd /root/越南摩托汽车网站
./backup-database.sh
```

**备份位置**：
```
/backup/database/vietnam_moto_auto_YYYYMMDD_HHMMSS.sqlite.gz
```

**恢复命令**：
```bash
# 1. 停止后端服务
sudo systemctl stop vietnam-moto-backend

# 2. 解压并恢复数据库
gunzip -c /backup/database/vietnam_moto_auto_20251012_020000.sqlite.gz > \
  /var/www/vietnam-moto-auto/backend/database/vietnam_moto_auto.sqlite

# 3. 启动后端服务
sudo systemctl start vietnam-moto-backend
```

**定时备份设置**：
```bash
# 编辑 crontab
sudo crontab -e

# 添加定时任务（每天凌晨2点自动备份）
0 2 * * * /root/越南摩托汽车网站/backup-database.sh >> /var/log/db-backup.log 2>&1
```

---

## 🏗️ 系统架构

### 技术栈

**前端：**
- Astro 4.x - 静态站点生成器
- React 18 - UI组件库
- TailwindCSS - CSS框架
- TypeScript - 类型安全

**后端：**
- Node.js 20+ - 运行环境
- Express.js 5.x - Web框架
- SQLite 3.x - 轻量级数据库
- Sequelize - ORM工具
- TypeScript - 类型安全

**部署：**
- Systemd - 服务管理
- Nginx - 反向代理和静态文件服务

---

## 🌐 端口和访问配置

### 端口分配

| 服务 | 端口 | 用途 | 访问方式 |
|------|------|------|----------|
| **Astro 前端** | **4321** | **前端预览服务** | **外部（生产环境主要入口）** |
| Node.js 后端 | 4001 | API服务 | 内部 + 外部 |
| Nginx | 80 | 静态文件服务（备用） | 外部 |

### 访问地址

**⚠️ 重要说明：4321 是生产环境端口！**

**前端页面（推荐）：**
```
主要地址: http://47.237.79.9:4321/  （Astro Preview - 生产环境）
备用地址: http://47.237.79.9/       （Nginx静态文件）
```

**后端API：**
```
直接访问: http://47.237.79.9:4001/api/vehicles/motorcycles
健康检查: http://47.237.79.9:4001/health
```

### 端口说明

- **4321端口**：**生产环境的前端服务端口**
  - 运行 `npm run preview` 启动Astro预览服务
  - 通过 systemd 服务 `vietnam-moto-frontend` 管理
  - 监听 `0.0.0.0:4321`（允许外部访问）
  
- **4001端口**：后端API服务端口
  - Express.js 应用
  - 通过 systemd 服务 `vietnam-moto-backend` 管理
  
- **80端口**：Nginx备用访问（静态文件）
  - 服务器上有多个网站共存
  - 需要通过 `server_name` 区分不同网站

---

## 📁 重要文件和目录

### 项目目录结构

```
源码目录（开发环境）
/root/越南摩托汽车网站/
├── backend/              # 后端源码
│   ├── src/             # TypeScript源码
│   ├── database/        # 数据库文件
│   └── dist/            # 编译后的JS文件
├── frontend/            # 前端源码
│   ├── src/             # Astro/React源码
│   └── dist/            # 构建后的静态文件
├── docs/                # 开发文档
├── deploy.sh            # 部署脚本 v2.0
└── backup-database.sh   # 数据库备份脚本

生产目录
/var/www/vietnam-moto-auto/
├── backend/
│   ├── dist/            # 后端运行文件
│   ├── database/        # 生产数据库
│   ├── logs/            # 日志文件
│   ├── uploads/         # 上传文件
│   └── .env.production  # 生产环境变量
└── frontend/
    └── dist/            # 前端静态文件

备份目录
/backup/
├── database/            # 数据库备份（永久）
└── deployment_YYYYMMDD_HHMMSS/  # 回滚备份（临时）
```

### 配置文件位置

**前端配置（⚠️ 重要）：**
```
# Astro配置（源文件 - 部署脚本会从这里复制）
/root/越南摩托汽车网站/frontend/astro.config.mjs

# 环境变量（源文件 - 部署脚本会从这里复制）
/root/越南摩托汽车网站/frontend/.env.production

# 生产环境配置
/var/www/vietnam-moto-auto/frontend/astro.config.mjs
/var/www/vietnam-moto-auto/frontend/.env.production
```

**关键配置内容：**

`astro.config.mjs` 必须包含：
```javascript
export default defineConfig({
  output: 'static',
  integrations: [react()],
  server: {
    host: '0.0.0.0',  // ⚠️ 必须是0.0.0.0，允许外部访问！
    port: 4321
  },
  vite: {
    plugins: [tailwindcss()]
  }
});
```

`.env.production` 内容：
```
PUBLIC_API_URL=http://47.237.79.9:4001
```

**后端环境变量：**
```
/var/www/vietnam-moto-auto/backend/.env.production
```

**Systemd 服务：**
```
/etc/systemd/system/vietnam-moto-frontend.service  (前端服务 - 4321端口)
/etc/systemd/system/vietnam-moto-backend.service   (后端服务 - 4001端口)
```

**Nginx 配置：**
```
# 源文件（⚠️ 重要！部署脚本会从这里复制）
/root/越南摩托汽车网站/nginx/vietnam-moto-auto.conf

# 生产环境配置
/etc/nginx/conf.d/vietnam-moto-auto.conf
```

**Nginx配置关键点：**
```nginx
server {
    listen 80;
    server_name 47.237.79.9 localhost;  # ⚠️ 必须指定IP，不能用 _ ！
    # ...
}
```

**数据库文件：**
```
开发: /root/越南摩托汽车网站/backend/database/vietnam_moto_auto.sqlite
生产: /var/www/vietnam-moto-auto/backend/database/vietnam_moto_auto.sqlite
```

---

## 🛠️ 服务管理

### Systemd 服务管理

**⚠️ 注意：生产环境有两个服务需要管理！**
- `vietnam-moto-frontend` - 前端服务（4321端口）
- `vietnam-moto-backend` - 后端服务（4001端口）

#### 前端服务管理

**查看服务状态：**
```bash
sudo systemctl status vietnam-moto-frontend
```

**重启服务：**
```bash
sudo systemctl restart vietnam-moto-frontend
```

**查看实时日志：**
```bash
sudo journalctl -u vietnam-moto-frontend -f
```

**启用开机自启：**
```bash
sudo systemctl enable vietnam-moto-frontend
```

#### 后端服务管理

**查看服务状态：**
```bash
sudo systemctl status vietnam-moto-backend
```

**重启服务：**
```bash
sudo systemctl restart vietnam-moto-backend
```

**停止服务：**
```bash
sudo systemctl stop vietnam-moto-backend
```

**启动服务：**
```bash
sudo systemctl start vietnam-moto-backend
```

**查看实时日志：**
```bash
sudo journalctl -u vietnam-moto-backend -f
```

**查看最近日志：**
```bash
sudo journalctl -u vietnam-moto-backend -n 50
```

**启用开机自启：**
```bash
sudo systemctl enable vietnam-moto-backend
```

#### 同时管理两个服务

```bash
# 重启所有服务
sudo systemctl restart vietnam-moto-frontend vietnam-moto-backend

# 查看所有服务状态
systemctl is-active vietnam-moto-frontend vietnam-moto-backend nginx
```

### Nginx 管理

**测试配置：**
```bash
sudo nginx -t
```

**重新加载配置（无缝切换，不停机）：**
```bash
sudo systemctl reload nginx
```

**重启 Nginx：**
```bash
sudo systemctl restart nginx
```

**查看状态：**
```bash
sudo systemctl status nginx
```

**查看访问日志：**
```bash
tail -f /var/log/nginx/vietnam-moto-auto.access.log
```

**查看错误日志：**
```bash
tail -f /var/log/nginx/vietnam-moto-auto.error.log
```

---

## 🔄 更新和部署流程

### 快速更新（推荐）

**适用场景：**
- 代码修改后重新部署
- 依赖包更新
- 配置文件修改

**步骤：**
```bash
cd /root/越南摩托汽车网站
sudo bash ./deploy.sh
```

**脚本自动完成：**
1. ✅ 备份当前版本和数据库
2. ✅ 复制新代码（排除数据库）
3. ✅ 安装依赖
4. ✅ 编译和构建
5. ✅ 配置环境
6. ✅ 重启服务
7. ✅ 健康检查

### 仅更新前端

```bash
cd /var/www/vietnam-moto-auto/frontend
npm run build
sudo systemctl reload nginx
```

### 仅更新后端

```bash
cd /var/www/vietnam-moto-auto/backend
npm run build
sudo systemctl restart vietnam-moto-backend
```

### 回滚到上一版本

**如果部署失败，脚本会自动回滚。手动回滚：**

```bash
# 1. 找到最近的回滚备份
ls -lt /backup/ | grep deployment

# 2. 停止服务
sudo systemctl stop vietnam-moto-backend

# 3. 恢复备份
sudo rm -rf /var/www/vietnam-moto-auto
sudo mv /backup/deployment_20251012_020142 /var/www/vietnam-moto-auto

# 4. 重启服务
sudo systemctl start vietnam-moto-backend
sudo systemctl reload nginx
```

---

## 📊 数据库管理

### 数据库配置

**类型**：SQLite 3.x

**位置**：
```
开发: /root/越南摩托汽车网站/backend/database/vietnam_moto_auto.sqlite
生产: /var/www/vietnam-moto-auto/backend/database/vietnam_moto_auto.sqlite
```

**特性**：
- WAL模式（Write-Ahead Logging）
- 外键约束启用
- FTS5全文搜索
- JSON字段支持

### 数据库备份

**手动备份：**
```bash
./backup-database.sh
```

**自动备份（定时任务）：**
```bash
sudo crontab -e
# 添加：每天凌晨2点备份
0 2 * * * /root/越南摩托汽车网站/backup-database.sh >> /var/log/db-backup.log 2>&1
```

**查看备份：**
```bash
ls -lh /backup/database/
```

### 数据库恢复

```bash
# 停止服务
sudo systemctl stop vietnam-moto-backend

# 恢复数据库
gunzip -c /backup/database/vietnam_moto_auto_YYYYMMDD_HHMMSS.sqlite.gz > \
  /var/www/vietnam-moto-auto/backend/database/vietnam_moto_auto.sqlite

# 设置权限
chmod 666 /var/www/vietnam-moto-auto/backend/database/vietnam_moto_auto.sqlite

# 启动服务
sudo systemctl start vietnam-moto-backend
```

---

## 🔍 监控和日志

### 应用日志

**后端日志：**
```bash
# 标准输出日志
tail -f /var/www/vietnam-moto-auto/backend/logs/backend.log

# 错误日志
tail -f /var/www/vietnam-moto-auto/backend/logs/backend-error.log

# Systemd日志
sudo journalctl -u vietnam-moto-backend -f
```

**Nginx日志：**
```bash
# 访问日志
tail -f /var/log/nginx/vietnam-moto-auto.access.log

# 错误日志
tail -f /var/log/nginx/vietnam-moto-auto.error.log
```

### 健康检查

**后端健康检查：**
```bash
curl http://localhost:4001/health
```

**预期响应：**
```json
{
  "status": "OK",
  "timestamp": "2025-10-12T02:14:59.253Z",
  "uptime": 123.456,
  "environment": "production"
}
```

**前端健康检查：**
```bash
curl -I http://localhost:4321/
```

**预期响应：**
```
HTTP/1.1 200 OK
```

---

## 🆘 常见问题和解决方案

### 1. 部署失败怎么办？

**脚本会自动回滚，无需手动操作。**

**查看失败原因：**
```bash
# 查看部署日志
cat /var/log/vietnam-moto-deploy.log

# 查看服务状态
sudo systemctl status vietnam-moto-frontend
sudo systemctl status vietnam-moto-backend

# 查看详细日志
sudo journalctl -u vietnam-moto-frontend -n 100
sudo journalctl -u vietnam-moto-backend -n 100
```

### 2. 网站无法访问（4321端口）？⚠️ 常见问题

**问题A：4321端口打不开**

**原因**：前端服务未启动或监听配置错误

**解决方案：**

```bash
# 1. 检查前端服务状态
sudo systemctl status vietnam-moto-frontend

# 2. 如果服务未运行，启动它
sudo systemctl start vietnam-moto-frontend

# 3. 检查端口监听（必须是0.0.0.0:4321，不是::1:4321）
netstat -tlnp | grep 4321

# 4. 如果只监听本地（::1），检查配置
cat /var/www/vietnam-moto-auto/frontend/astro.config.mjs

# 5. 确保配置包含以下内容：
server: {
  host: '0.0.0.0',
  port: 4321
}

# 6. 重启服务
sudo systemctl restart vietnam-moto-frontend
```

**问题B：80端口被其他网站拦截**

**原因**：服务器上有多个网站，Nginx配置冲突

**症状**：访问 http://47.237.79.9 被重定向到其他网站（如cryptopulse.work）

**解决方案：**

```bash
# 1. 检查Nginx配置中的server_name
cat /etc/nginx/conf.d/vietnam-moto-auto.conf | grep server_name

# 2. 必须指定具体IP或域名，不能用通配符 _
# 正确配置：
server_name 47.237.79.9 localhost;

# 错误配置：
server_name _;  # 这个优先级太低，会被其他配置覆盖

# 3. 修改源文件（重要！）
vi /root/越南摩托汽车网站/nginx/vietnam-moto-auto.conf

# 4. 删除冲突的配置文件
ls /etc/nginx/conf.d/*.conf  # 检查是否有其他80端口配置
sudo rm /etc/nginx/conf.d/cryptopulse-*.conf  # 删除不用的配置

# 5. 重新部署
sudo ./deploy.sh
```

### 3. 网站检查步骤

**完整检查流程：**

```bash
# 1. 检查端口监听
netstat -tlnp | grep -E "4321|4001|:80 "
# 应该看到：
# 0.0.0.0:4321  (前端)
# :::4001       (后端)
# 0.0.0.0:80    (Nginx)

# 2. 检查服务状态
systemctl is-active vietnam-moto-frontend vietnam-moto-backend nginx
# 应该都是 active

# 3. 测试本地访问
curl -I http://localhost:4321/
curl http://localhost:4001/health

# 4. 测试外部访问
curl -I http://47.237.79.9:4321/
curl http://47.237.79.9:4001/health
```

### 4. 前端修改不生效？

**原因：**浏览器缓存或构建缓存

**解决方案：**
```bash
# 1. 清除构建缓存
cd /var/www/vietnam-moto-auto/frontend
rm -rf dist node_modules/.vite

# 2. 重新构建
npm run build

# 3. 重启前端服务（重要！）
sudo systemctl restart vietnam-moto-frontend

# 4. 如果使用Nginx访问，也重新加载Nginx
sudo systemctl reload nginx

# 5. 清除浏览器缓存
# Ctrl+Shift+R (Chrome/Firefox)
```

### 5. 后端修改不生效？

**解决方案：**
```bash
# 1. 重新编译
cd /var/www/vietnam-moto-auto/backend
npm run build

# 2. 检查编译结果
ls -la dist/

# 3. 重启服务
sudo systemctl restart vietnam-moto-backend

# 4. 查看日志
sudo journalctl -u vietnam-moto-backend -f
```

### 6. 数据库错误？

**常见错误：**
- `SQLITE_ERROR: no such column`
- `SQLITE_BUSY: database is locked`

**解决方案：**
```bash
# 1. 检查数据库文件
ls -lh /var/www/vietnam-moto-auto/backend/database/vietnam_moto_auto.sqlite

# 2. 检查数据库完整性
sqlite3 /var/www/vietnam-moto-auto/backend/database/vietnam_moto_auto.sqlite \
  "PRAGMA integrity_check;"

# 3. 如果损坏，恢复最近备份
gunzip -c /backup/database/vietnam_moto_auto_YYYYMMDD.sqlite.gz > \
  /var/www/vietnam-moto-auto/backend/database/vietnam_moto_auto.sqlite

# 4. 重启服务
sudo systemctl restart vietnam-moto-backend
```

### 7. API返回500错误？

**检查步骤：**
```bash
# 1. 查看后端错误日志
tail -50 /var/www/vietnam-moto-auto/backend/logs/backend-error.log

# 2. 查看Systemd日志
sudo journalctl -u vietnam-moto-backend -n 50

# 3. 测试数据库连接
sqlite3 /var/www/vietnam-moto-auto/backend/database/vietnam_moto_auto.sqlite \
  "SELECT COUNT(*) FROM motorcycles;"

# 4. 检查环境变量
cat /var/www/vietnam-moto-auto/backend/.env.production
```

### 8. 端口冲突？

**问题：**80端口被其他服务占用

**解决方案：**
```bash
# 查看哪个进程占用80端口
sudo lsof -i :80

# 修改为其他端口（已使用4321和8088）
sudo vi /etc/nginx/conf.d/vietnam-moto-auto.conf
# 修改 listen 80; 为 listen 4321;

# 重新加载Nginx
sudo nginx -t
sudo systemctl reload nginx
```

---

## 💡 最佳实践

### 部署前

1. **备份数据库**
   ```bash
   ./backup-database.sh
   ```

2. **在开发环境测试**
   ```bash
   cd /root/越南摩托汽车网站/frontend
   npm run dev
   
   cd /root/越南摩托汽车网站/backend
   npm run dev
   ```

3. **代码检查**
   ```bash
   npm run lint
   npm run build  # 确保编译成功
   ```

### 部署中

1. **使用部署脚本**
   ```bash
   sudo bash ./deploy.sh
   ```

2. **观察日志输出**
   - 确认每个步骤都成功
   - 注意警告和错误信息

3. **不要手动中断**
   - 脚本有自动回滚机制
   - 中断可能导致不一致状态

### 部署后

1. **验证部署结果**
   ```bash
   # 检查服务状态
   sudo systemctl status vietnam-moto-backend
   
   # 测试API
   curl http://localhost:4321/api/vehicles/motorcycles?limit=1
   
   # 访问网站
   curl -I http://localhost:4321/
   ```

2. **查看日志**
   ```bash
   # 查看是否有错误
   tail -50 /var/www/vietnam-moto-auto/backend/logs/backend-error.log
   ```

3. **浏览器测试**
   - 打开网站首页
   - 测试主要功能
   - 检查数据显示

4. **清理临时文件**
   ```bash
   # 确认部署成功后，可删除回滚备份
   rm -rf /backup/deployment_YYYYMMDD_HHMMSS
   ```

### 定期维护

1. **每日自动备份**
   ```bash
   # 设置cron任务
   0 2 * * * /root/越南摩托汽车网站/backup-database.sh
   ```

2. **每周检查日志**
   ```bash
   # 查看错误日志
   grep -i error /var/www/vietnam-moto-auto/backend/logs/backend-error.log
   ```

3. **每月清理旧备份**
   ```bash
   # 保留最近30天的备份，删除更早的
   find /backup/database -name "*.sqlite.gz" -mtime +30 -delete
   ```

---

---

## 📋 完整部署检查清单

### ✅ 部署前检查清单

#### 1. 自动化检查工具（推荐）

**使用deployment-health-check.sh进行全面检查**：
```bash
cd /root/越南摩托汽车网站
sudo ./scripts/deployment-health-check.sh
```

**检查维度（8个方面）**：
- ✅ 前端API配置（环境变量、硬编码地址、相对路径）
- ✅ 后端配置（路由注册、CORS设置）
- ✅ Nginx配置（代理配置、server_name）
- ✅ Systemd服务（启动路径、环境变量、权限）
- ✅ 运行时状态（服务状态、端口监听）
- ✅ API连通性（健康检查、Sitemap API）
- ✅ 数据库状态（文件存在、数据完整性）
- ✅ 关键文件（sitemap文件、robots.txt）

#### 2. 代码配置检查

**前端API配置**：
- [ ] 删除所有`.env.production`文件（域名+SSL模式）
  ```bash
  rm -f /root/越南摩托汽车网站/frontend/.env*
  ```

- [ ] 客户端代码使用相对路径`/api`
  - `src/services/marketplaceApi.ts` → `const API_BASE_URL = '/api'`
  - `src/services/reviewsApi.ts` → `const API_BASE_URL = '/api'`
  - `src/services/qaApi.ts` → `const API_BASE_URL = '/api'`

- [ ] SSR页面使用完整内网地址`http://localhost:4001/api`
  - `src/pages/cars/[slug].astro`
  - `src/pages/motorcycles/[id].astro`
  - `src/pages/marketplace/[id].astro`
  - 所有`sitemap-*.xml.ts`文件

- [ ] 无硬编码HTTP地址（客户端代码）
  ```bash
  grep -r "http://localhost:4001\|http://47\.237\.79\.9" \
    /root/越南摩托汽车网站/frontend/src/ | \
    grep -v "\.astro" | grep -v "sitemap"
  # 应该无输出
  ```

**后端配置检查**：
- [ ] Sitemap路由已导入和注册
  ```typescript
  // backend/src/index.ts
  import sitemapRoutes from './routes/sitemap';
  app.use('/api/sitemap', sitemapRoutes);
  ```

- [ ] CORS配置包含所有必要域名
  ```typescript
  const allowedOrigins = [
    'http://localhost:4321',
    'https://vietmoto.top',
    'http://127.0.0.1:4321'
  ];
  ```

#### 3. 配置文件检查

**Nginx配置（vietmoto.conf）**：
- [ ] API代理配置正确
  ```nginx
  location /api/ {
      proxy_pass http://127.0.0.1:4001;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
  }
  ```

- [ ] 静态资源配置正确
  ```nginx
  location /_astro/ {
      alias /var/www/vietnam-moto-auto/frontend/dist/client/_astro/;
      expires 1y;
  }
  ```

- [ ] server_name使用具体域名
  ```nginx
  server_name vietmoto.top www.vietmoto.top;  # ✅ 正确
  ```

**Systemd服务配置**：
- [ ] 前端服务使用SSR模式
  ```ini
  # /etc/systemd/system/vietnam-moto-frontend.service
  ExecStart=/usr/bin/node dist/server/entry.mjs  # ✅ SSR模式
  WorkingDirectory=/var/www/vietnam-moto-auto/frontend
  ```

- [ ] 后端服务启动路径正确
  ```ini
  ExecStart=/usr/bin/node dist/index.js  # ✅ 正确
  Environment=DB_PATH=/var/www/vietnam-moto-auto/backend/database/vietnam_moto_auto.sqlite
  ReadWritePaths=/var/www/vietnam-moto-auto/backend/database
  ```

**Astro配置**：
- [ ] 使用server模式（SSR）
  ```javascript
  // astro.config.mjs
  export default defineConfig({
    output: 'server',  // SSR模式
    adapter: node({ mode: 'standalone' }),
    server: {
      host: '0.0.0.0',  // 监听所有接口
      port: 4321
    },
  });
  ```

#### 4. 数据库检查

- [ ] 开发环境数据库存在且有数据
  ```bash
  ls -lh /root/越南摩托汽车网站/backend/database/vietnam_moto_auto.sqlite
  sqlite3 vietnam_moto_auto.sqlite "SELECT COUNT(*) FROM motorcycles;"
  ```

- [ ] 关键表存在
  ```bash
  sqlite3 vietnam_moto_auto.sqlite ".tables" | \
    grep -E "marketplace_vehicles|cars|motorcycles"
  ```

#### 5. CSS文件检查（重要！）

- [ ] 检查CSS文件名大小写
  ```bash
  ls /root/越南摩托汽车网站/frontend/dist/client/_astro/*.css
  # 检查是否有大小写混合的文件名
  ```

- [ ] 确保部署脚本会创建符号链接
  ```bash
  grep "符号链接\|symbolic" deploy.sh quick-deploy.sh
  ```

### 🚀 部署执行

#### 推荐流程
```bash
cd /root/越南摩托汽车网站

# 1. 运行部署前检查（强烈推荐）
sudo ./scripts/deployment-health-check.sh

# 2. 如果检查通过，执行部署
sudo ./deploy.sh

# 3. 部署后再次检查
sudo ./scripts/deployment-health-check.sh
```

#### 快速部署（小更新）
```bash
# 只部署前端
sudo ./quick-deploy.sh frontend

# 只部署后端
sudo ./quick-deploy.sh backend

# 验证
sudo ./scripts/deployment-health-check.sh
```

### ✅ 部署后验证清单

#### 1. 服务状态检查

- [ ] 所有服务运行正常
  ```bash
  systemctl is-active vietnam-moto-frontend vietnam-moto-backend nginx
  # 应该都显示: active
  ```

- [ ] 查看详细状态
  ```bash
  sudo systemctl status vietnam-moto-frontend
  sudo systemctl status vietnam-moto-backend
  ```

#### 2. 端口监听检查

- [ ] 检查所有端口正常监听
  ```bash
  netstat -tlnp | grep -E ":4001|:4321|:80|:443"
  # 应该看到：
  # 0.0.0.0:4321  (前端SSR)
  # :::4001       (后端API)
  # 0.0.0.0:80    (Nginx HTTP)
  # 0.0.0.0:443   (Nginx HTTPS)
  ```

#### 3. API连通性测试

- [ ] 后端健康检查
  ```bash
  curl --noproxy '*' http://localhost:4001/health
  # 应该返回: {"status":"OK",...}
  ```

- [ ] Sitemap API测试
  ```bash
  curl --noproxy '*' http://localhost:4001/api/sitemap/motorcycles | jq '.data | length'
  # 应该返回数字（如 126）
  ```

- [ ] 通过域名测试API
  ```bash
  curl https://vietmoto.top/api/health
  # 应该返回: {"status":"OK",...}
  ```

#### 4. 前端访问测试

- [ ] 主页可访问
  ```bash
  curl -I https://vietmoto.top/
  # 应该返回: HTTP/2 200
  ```

- [ ] CSS加载正常
  ```bash
  # 使用浏览器访问
  # 按F12查看Network标签
  # 确认所有CSS文件都是200状态，content-type是text/css
  ```

- [ ] 详情页SSR正常
  ```bash
  curl https://vietmoto.top/motorcycles/1 | grep -o "<title>.*</title>"
  # 应该包含车辆标题
  ```

#### 5. 数据库验证

- [ ] 生产数据库完整性
  ```bash
  sqlite3 /var/www/vietnam-moto-auto/backend/database/vietnam_moto_auto.sqlite \
    "PRAGMA integrity_check;"
  # 应该返回: ok
  ```

- [ ] 数据量验证
  ```bash
  sqlite3 /var/www/vietnam-moto-auto/backend/database/vietnam_moto_auto.sqlite "
  SELECT 
    (SELECT COUNT(*) FROM motorcycles WHERE status='active') as motos,
    (SELECT COUNT(*) FROM cars WHERE status='active') as cars;"
  # 应该显示正确的数据量
  ```

#### 6. Sitemap验证

- [ ] Sitemap索引可访问
  ```bash
  curl https://vietmoto.top/sitemap-index.xml | grep -c "<sitemap>"
  # 应该返回: 5
  ```

- [ ] 各子sitemap URL数量正确
  ```bash
  for sitemap in static motorcycles cars reviews marketplace; do
    count=$(curl -s "https://vietmoto.top/sitemap-$sitemap.xml" | grep -c "<url>")
    echo "sitemap-$sitemap.xml: $count URLs"
  done
  ```

#### 7. 日志检查

- [ ] 后端无严重错误
  ```bash
  sudo journalctl -u vietnam-moto-backend -n 50 --no-pager | grep -i "error"
  # 不应该有critical errors
  ```

- [ ] 前端无构建错误
  ```bash
  sudo journalctl -u vietnam-moto-frontend -n 50 --no-pager
  # 确认服务正常运行
  ```

- [ ] Nginx无代理错误
  ```bash
  sudo tail -50 /var/log/nginx/vietmoto.error.log
  # 不应该有502/504错误
  ```

#### 8. CSS加载监控

- [ ] 运行CSS加载检查脚本
  ```bash
  cd /root/越南摩托汽车网站
  ./check-css-loading.sh
  ```

- [ ] 检查最近的CSS 404错误
  ```bash
  tail -100 /var/log/nginx/vietmoto.access.log | grep "\.css" | grep " 404 "
  # 应该无输出
  ```

### 🆘 常见问题快速修复

#### 问题1: 前端无法获取后端数据

**症状**：页面显示"加载中..."或"获取数据失败"

**快速诊断**：
```bash
# 1. 测试后端API
curl http://localhost:4001/health

# 2. 测试通过Nginx代理
curl https://vietmoto.top/api/health

# 3. 检查前端代码API路径
grep "API_BASE_URL\|API_URL" frontend/src/services/*.ts
```

**修复方法**：
```bash
# 确保前端使用相对路径
rm -f frontend/.env*
sudo ./deploy.sh
```

#### 问题2: CSS样式加载失败（白页）

**症状**：网站打开是白页，浏览器控制台显示CSS 404错误

**快速诊断**：
```bash
# 检查CSS文件是否存在
ls -la /var/www/vietnam-moto-auto/frontend/dist/client/_astro/*.css

# 检查Nginx错误日志
tail -50 /var/log/nginx/vietmoto.error.log | grep "\.css"
```

**修复方法**：
```bash
# 1. 创建符号链接（临时）
cd /var/www/vietnam-moto-auto/frontend/dist/client/_astro
for file in *.css; do
    lowercase=$(echo "$file" | tr '[:upper:]' '[:lower:]')
    if [ "$file" != "$lowercase" ]; then
        ln -sf "$file" "$lowercase"
    fi
done

# 2. 重新部署（永久解决）
cd /root/越南摩托汽车网站
sudo ./deploy.sh
```

#### 问题3: SSR详情页显示404或无数据

**症状**：动态路由页面无法显示内容

**快速诊断**：
```bash
# 1. 测试后端API
curl http://localhost:4001/api/vehicles/cars/slug/toyota-vios-2024

# 2. 检查SSR页面代码
grep "API_URL" frontend/src/pages/cars/[slug].astro
# 应该是: const API_URL = 'http://localhost:4001/api';
```

**修复方法**：
确保所有SSR页面使用完整的内网URL，然后重新部署

#### 问题4: Sitemap数据不准确

**症状**：Google Search Console显示URL数量不匹配

**快速诊断**：
```bash
# 1. 测试专用sitemap API
curl http://localhost:4001/api/sitemap/motorcycles | jq '.data | length'

# 2. 对比数据库实际数量
sqlite3 /var/www/vietnam-moto-auto/backend/database/vietnam_moto_auto.sqlite \
  "SELECT COUNT(*) FROM motorcycles WHERE status='active';"
```

**修复方法**：
确保sitemap使用专用API（`/api/sitemap/*`），而不是普通API

#### 问题5: 服务启动失败

**症状**：`systemctl status` 显示 failed

**快速诊断**：
```bash
# 1. 查看详细日志
sudo journalctl -u vietnam-moto-backend -n 100 --no-pager

# 2. 检查启动路径
grep "ExecStart" /etc/systemd/system/vietnam-moto-backend.service
# 应该是: dist/index.js
```

**修复方法**：
```bash
# 1. 重新编译
cd /var/www/vietnam-moto-auto/backend
npm run build

# 2. 重启服务
sudo systemctl restart vietnam-moto-backend
```

### 🛠️ 自动化检查工具

#### deployment-health-check.sh

**功能**：全面检查部署环境的8个维度

**位置**：`scripts/deployment-health-check.sh`

**使用**：
```bash
sudo ./scripts/deployment-health-check.sh
```

**输出示例**：
```
=== 系统健康检查报告 ===

✅ 前端API配置: 全部正确
✅ 后端配置: 全部正确  
✅ Nginx配置: 全部正确
✅ Systemd服务: 全部正确
✅ 运行时状态: 所有服务运行正常
✅ API连通性: 正常
✅ 数据库: 完整且有数据
✅ 关键文件: 全部存在

📊 总结: 0个严重问题，0个警告
```

#### check-css-loading.sh

**功能**：专门检查CSS文件加载情况

**位置**：`check-css-loading.sh`

**使用**：
```bash
./check-css-loading.sh
```

**检查内容**：
- Nginx日志中的CSS 404错误
- 主要CSS文件的可访问性
- 符号链接的正确性

### 📊 部署检查快速验证脚本

**一键验证所有关键功能**：

```bash
#!/bin/bash
echo "=== 快速验证脚本 ==="

echo -e "\n1. 服务状态"
systemctl is-active vietnam-moto-frontend vietnam-moto-backend nginx

echo -e "\n2. 端口监听"
netstat -tlnp | grep -E ":4001|:4321|:443"

echo -e "\n3. API测试"
curl -s http://localhost:4001/health | jq '.status'
curl -s https://vietmoto.top/api/health | jq '.status'

echo -e "\n4. 数据库"
sqlite3 /var/www/vietnam-moto-auto/backend/database/vietnam_moto_auto.sqlite \
  "SELECT 'Motorcycles: ' || COUNT(*) FROM motorcycles WHERE status='active';"

echo -e "\n5. CSS文件"
ls -1 /var/www/vietnam-moto-auto/frontend/dist/client/_astro/*.css | wc -l

echo -e "\n✅ 快速验证完成"
```

保存为`快速验证.sh`并使用：
```bash
chmod +x 快速验证.sh
./快速验证.sh
```

---

## 🔗 相关文档

- [README.md](./README.md) - 项目总览
- [项目架构开发文档.md](./项目架构开发文档.md) - 架构设计
- [数据库配置开发文档.md](./数据库配置开发文档.md) - 数据库设计
- [API路由开发文档.md](./API路由开发文档.md) - API文档
- [后端服务开发文档.md](./后端服务开发文档.md) - 后端开发指南
- [SEO优化完整指南.md](./SEO优化完整指南.md) - SEO最佳实践

---

## 🔧 部署问题案例和解决方案

### 案例1：前端服务未自动启动（2025-10-12）

**问题描述：**
- 使用 `deploy.sh` 部署后，http://47.237.79.9:4321 无法访问
- 只有后端服务在运行，前端服务未启动

**根本原因：**
- 部署脚本只启动了 `vietnam-moto-backend` 服务
- 忘记启动 `vietnam-moto-frontend` 服务

**解决方案：**
```bash
# 1. 更新 deploy.sh，添加前端服务启动
log_info "启动前端服务 (4321)..."
systemctl start vietnam-moto-frontend
systemctl enable vietnam-moto-frontend

# 2. 添加前端服务健康检查
if curl -f http://localhost:4321 > /dev/null 2>&1; then
    log_success "✅ 前端服务正常 (端口 4321)"
else
    log_warning "⚠️ 前端服务可能有问题"
fi
```

**修复位置：**
- 文件：`/root/越南摩托汽车网站/deploy.sh`
- 行数：第527-537行

---

### 案例2：4321端口只监听本地（2025-10-12）

**问题描述：**
- 前端服务启动了，但从外部无法访问
- `netstat` 显示只监听 `::1:4321`（本地），不是 `0.0.0.0:4321`（所有接口）

**根本原因：**
- `astro.config.mjs` 缺少 `server.host` 配置
- Astro默认只监听localhost

**解决方案：**
```javascript
// 修改 astro.config.mjs
export default defineConfig({
  output: 'static',
  integrations: [react()],
  server: {
    host: '0.0.0.0',  // 添加这个配置！
    port: 4321
  },
  vite: {
    plugins: [tailwindcss()]
  }
});
```

**需要修改的文件：**
- `/root/越南摩托汽车网站/frontend/astro.config.mjs` （源文件）
- `/var/www/vietnam-moto-auto/frontend/astro.config.mjs` （生产环境）

**验证方法：**
```bash
# 重启服务后检查
netstat -tlnp | grep 4321
# 应该看到：0.0.0.0:4321 或 *:4321
```

---

### 案例3：Nginx配置被其他网站覆盖（2025-10-12）

**问题描述：**
- 访问 http://47.237.79.9 被重定向到 `https://cryptopulse.work`
- 明明配置了vietnam-moto-auto，却访问不到

**根本原因：**
- 服务器上有多个网站共存
- `cryptopulse.work` 的配置使用了通配符 `server_name`
- vietnam-moto-auto 使用 `server_name _`，优先级太低

**Nginx匹配优先级：**
```
1. 完全匹配域名（如 server_name example.com）
2. 通配符域名（如 server_name *.example.com）
3. 正则表达式域名
4. 默认server（server_name _）← 优先级最低
```

**解决方案：**

1. **删除不用的配置文件：**
```bash
sudo rm /etc/nginx/conf.d/cryptopulse-*.conf
```

2. **修改vietnam-moto-auto配置：**
```nginx
# 错误配置（优先级太低）
server {
    listen 80;
    server_name _;  # ❌ 不要用这个
}

# 正确配置
server {
    listen 80;
    server_name 47.237.79.9 localhost;  # ✅ 指定具体IP
}
```

3. **⚠️ 重要：修改源文件！**
```bash
# 必须修改源文件，否则下次部署会被覆盖
vi /root/越南摩托汽车网站/nginx/vietnam-moto-auto.conf
```

4. **重新加载Nginx：**
```bash
sudo nginx -t
sudo systemctl reload nginx
```

**验证方法：**
```bash
# 测试访问
curl -I http://47.237.79.9
# 应该返回 HTTP/1.1 200 OK，不是301重定向
```

---

### 案例4：前端API调用失败（2025-10-12）

**问题描述：**
- 前端页面能打开，但数据加载失败
- 浏览器控制台显示API调用错误

**根本原因：**
- 缺少 `.env.production` 文件
- 前端不知道后端API地址

**解决方案：**

1. **创建环境变量文件：**
```bash
# 源文件
echo "PUBLIC_API_URL=http://47.237.79.9:4001" > /root/越南摩托汽车网站/frontend/.env.production

# 生产环境
echo "PUBLIC_API_URL=http://47.237.79.9:4001" > /var/www/vietnam-moto-auto/frontend/.env.production
```

2. **重新构建前端：**
```bash
cd /var/www/vietnam-moto-auto/frontend
npm run build
```

3. **重启前端服务：**
```bash
sudo systemctl restart vietnam-moto-frontend
```

**验证方法：**
```bash
# 检查环境变量文件
cat /var/www/vietnam-moto-auto/frontend/.env.production

# 测试API调用
curl http://47.237.79.9:4001/api/vehicles/motorcycles?limit=1
```

---

### 案例5：HTTPS混合内容错误（2025-10-14）⚠️ 域名+SSL部署必看

**问题描述：**
- 配置域名和SSL证书后，网站通过HTTPS访问
- 浏览器控制台报错：`Mixed Content: The page at 'https://vietmoto.top/marketplace' was loaded over HTTPS, but requested an insecure XMLHttpRequest endpoint 'http://47.237.79.9:4001/marketplace'`
- 所有API调用被浏览器安全策略阻止
- 页面显示"Lỗi: Network Error"

**根本原因：**
1. **环境变量配置错误**：`.env.production` 文件设置了 `PUBLIC_API_URL=http://47.237.79.9:4001`（HTTP地址）
2. **硬编码HTTP地址**：多个前端文件直接使用了 `http://localhost:4001` 或 `http://47.237.79.9:4001`
3. **未使用Nginx代理**：前端直接访问后端HTTP地址，而不是通过Nginx的HTTPS代理

**浏览器安全策略：**
- HTTPS页面不允许加载HTTP资源（Mixed Content）
- 所有API、图片、脚本都必须使用HTTPS
- 这是浏览器的强制安全机制，无法绕过

**影响范围（11个文件需要修复）：**
```
frontend/src/services/marketplaceApi.ts
frontend/src/services/reviewsApi.ts
frontend/src/services/qaApi.ts
frontend/src/components/MarketplaceSection.tsx
frontend/src/config/api.ts
frontend/src/pages/sitemap.xml.ts
frontend/src/pages/marketplace/[id].astro
frontend/src/pages/cars/[slug].astro
frontend/src/pages/qa/[id].astro
frontend/src/pages/reviews/[slug].astro
frontend/.env.production (需删除)
```

**解决方案：**

**1. 删除所有环境变量文件（⚠️ 重要）**
```bash
# 源目录
rm -f /root/越南摩托汽车网站/frontend/.env.production
rm -f /root/越南摩托汽车网站/frontend/.env*

# 生产目录（部署后）
rm -f /var/www/vietnam-moto-auto/frontend/.env.production
rm -f /var/www/vietnam-moto-auto/frontend/.env*
```

**原因**：使用域名+SSL时，不应该配置 `PUBLIC_API_URL`，应该使用相对路径通过Nginx代理。

**2. 修复所有API服务文件**

将所有 `API_BASE_URL` 从环境变量或硬编码改为固定的相对路径：

```typescript
// ❌ 错误写法
const API_BASE_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:4001/api';
const API_BASE_URL = typeof window !== 'undefined' ? '/api' : 'http://localhost:4001/api';
const API_URL = 'http://localhost:4001/api';

// ✅ 正确写法（使用相对路径）
const API_BASE_URL = '/api';
```

**修复文件列表：**
- `src/services/marketplaceApi.ts`
- `src/services/reviewsApi.ts`
- `src/services/qaApi.ts`
- `src/config/api.ts`
- `src/pages/sitemap.xml.ts`

**3. 修复React组件**

```typescript
// src/components/MarketplaceSection.tsx

// ❌ 错误
const response = await fetch(
  `${import.meta.env.PUBLIC_API_URL}/api/marketplace?...`
);

// ✅ 正确
const response = await fetch(
  `/api/marketplace?...`
);
```

**4. 修复Astro页面**

```typescript
// ❌ 错误
const response = await fetch(`http://localhost:4001/api/marketplace/${id}`);
const API_URL = 'http://localhost:4001/api';

// ✅ 正确
const response = await fetch(`/api/marketplace/${id}`);
const API_URL = '/api';
```

**5. 确保Nginx配置正确**

```nginx
# /etc/nginx/conf.d/vietmoto.conf

server {
    listen 443 ssl http2;
    server_name vietmoto.top;
    
    # SSL证书配置
    ssl_certificate /etc/letsencrypt/live/vietmoto.top/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/vietmoto.top/privkey.pem;
    
    # API代理（关键配置）
    location /api/ {
        proxy_pass http://127.0.0.1:4001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

**6. 重新构建和部署**

```bash
cd /root/越南摩托汽车网站/frontend
npm run build
rm -rf /var/www/vietnam-moto-auto/frontend/dist
cp -r dist /var/www/vietnam-moto-auto/frontend/
systemctl restart vietnam-moto-frontend
```

**API请求流程对比：**

```
错误流程（Mixed Content）：
浏览器 (HTTPS) → 直接请求 → http://47.237.79.9:4001/api ❌ 被阻止

正确流程：
浏览器 (HTTPS) → https://vietmoto.top/api → Nginx (443) 
  → proxy_pass → http://127.0.0.1:4001/api ✅ 安全
```

**验证方法：**

```bash
# 1. 检查是否还有HTTP地址
cd /root/越南摩托汽车网站/frontend
grep -r "localhost:4001\|47\.237\.79\.9" src/

# 2. 测试API（应该返回JSON数据）
curl https://vietmoto.top/api/marketplace?limit=1

# 3. 浏览器控制台不应该有Mixed Content错误
# 打开 https://vietmoto.top/marketplace
# 按F12查看控制台，不应该有红色错误
```

**重要提示：**

1. **IP地址部署 vs 域名+SSL部署的区别**：
   - IP地址（HTTP）：可以使用环境变量配置后端地址
   - 域名+SSL（HTTPS）：必须使用相对路径+Nginx代理
   
2. **不要混用HTTP和HTTPS**：
   - 整个网站要么全HTTP，要么全HTTPS
   - 不能在HTTPS页面中请求HTTP资源
   
3. **Nginx是必需的**：
   - 前端(HTTPS) ↔ Nginx ↔ 后端(HTTP内网)
   - 浏览器只看到HTTPS，内部通信可以是HTTP

4. **环境变量的坑**：
   - `.env.production` 在构建时会被打包进代码
   - 即使删除文件，已构建的代码仍包含旧值
   - 修改后必须重新 `npm run build`

**适用场景：**
- 使用域名访问（如 vietmoto.top）
- 配置了SSL证书（Let's Encrypt等）
- 需要HTTPS加密传输
- 生产环境推荐配置

---

### 案例6：SSR详情页无法显示内容（2025-10-14）⚠️ SSR部署必看

**问题描述：**
- 配置域名和SSL后，所有详情页都无法显示内容
- 汽车详情页：404错误
- 二手交易详情页：显示"❌ 获取数据失败"
- 摩托车、问答、测评详情页：全部报错或无内容

**根本原因：**
1. **SSR渲染环境问题**：Astro SSR页面在服务器端执行，无法解析相对路径 `/api`
2. **API调用路径错误**：所有详情页使用相对路径 `/api`，在服务器端渲染时失败
3. **客户端和服务器端混淆**：没有区分浏览器环境和Node.js服务器环境

**技术原理：**

```
浏览器环境（客户端JavaScript）：
- 可以使用相对路径 /api
- 通过Nginx代理到后端
- URL: https://vietmoto.top/api → http://127.0.0.1:4001

服务器环境（Astro SSR）：
- 无法使用相对路径 /api
- 没有域名和协议上下文
- 必须使用完整URL: http://localhost:4001/api
```

**影响范围（5个详情页文件）：**
```
frontend/src/pages/cars/[slug].astro           - 汽车详情页
frontend/src/pages/motorcycles/[id].astro      - 摩托车详情页
frontend/src/pages/marketplace/[id].astro      - 二手交易详情页
frontend/src/pages/qa/[id].astro               - 问答详情页
frontend/src/pages/reviews/[slug].astro        - 测评详情页
```

**解决方案：**

**1. 修复所有SSR详情页的API调用**

将所有详情页的API URL从相对路径改为完整URL：

```typescript
// ❌ 错误写法（SSR环境下无法工作）
const API_URL = '/api';
const response = await fetch(`/api/vehicles/cars/slug/${slug}`);

// ✅ 正确写法（SSR环境）
const API_URL = 'http://localhost:4001/api';
const response = await fetch(`${API_URL}/vehicles/cars/slug/${slug}`);
```

**2. 修复的文件示例**

```typescript
// frontend/src/pages/cars/[slug].astro
---
import BaseLayout from '../../layouts/BaseLayout.astro';

// 使用服务端渲染，不预渲染静态页面
export const prerender = false;

const { slug } = Astro.params;

// SSR模式下使用完整的内网地址
const API_URL = 'http://localhost:4001/api';

let car: any = null;
let error = false;

try {
  const response = await fetch(`${API_URL}/vehicles/cars/slug/${slug}`, {
    headers: {
      'Accept': 'application/json'
    }
  });
  
  if (!response.ok) {
    console.error(`API request failed: ${response.status}`);
    error = true;
  } else {
    const result = await response.json();
    if (result.success) {
      car = result.data;
    }
  }
} catch (err) {
  console.error('Failed to fetch car:', err);
  error = true;
}
---
```

**3. 设置正确的prerender选项**

所有动态详情页必须禁用预渲染：

```typescript
// ✅ 正确：使用SSR模式
export const prerender = false;

// ❌ 错误：使用静态预渲染
export const prerender = true;
// 或使用 getStaticPaths（不适合动态内容）
```

**4. 客户端JavaScript继续使用相对路径**

```typescript
// 客户端脚本（<script>标签中）
const API_BASE_URL = '/api';  // ✅ 正确，通过Nginx代理
fetch(`${API_BASE_URL}/reviews/slug/${slug}`)
  .then(res => res.json())
  .then(data => {
    // 处理数据
  });
```

**API请求流程对比：**

```
SSR渲染流程（服务器端）：
用户访问 → Nginx (443) → 前端SSR服务器 (4321)
                              ↓
          直接请求 → http://localhost:4001/api
                              ↓
                          后端API返回数据
                              ↓
                          渲染完整HTML
                              ↓
                      返回给浏览器

客户端请求流程（浏览器）：
用户操作 → 浏览器JavaScript → /api/...
                              ↓
                      Nginx代理 (443)
                              ↓
                  http://127.0.0.1:4001/api
                              ↓
                      后端API返回JSON
                              ↓
                    前端JavaScript更新页面
```

**验证方法：**

```bash
# 1. 测试SSR渲染（服务器端）
curl http://localhost:4321/cars/toyota-vios-2024
# 应该返回完整的HTML，包含车辆数据

# 2. 测试API直接访问
curl http://localhost:4001/api/vehicles/cars/slug/toyota-vios-2024
# 应该返回JSON数据

# 3. 测试通过域名访问
curl https://vietmoto.top/cars/toyota-vios-2024
# 应该返回完整的HTML页面

# 4. 检查服务状态
systemctl status vietnam-moto-frontend
systemctl status vietnam-moto-backend
```

**重要提示：**

1. **区分渲染环境**：
   - SSR（服务器端）：使用 `http://localhost:4001/api`
   - CSR（客户端）：使用 `/api`（通过Nginx代理）

2. **prerender设置**：
   - 动态详情页：`export const prerender = false`
   - 静态页面：`export const prerender = true`

3. **开发vs生产**：
   - 开发环境：可以直接访问 `localhost:4001`
   - 生产环境（SSR）：仍需使用 `localhost:4001`（内网通信）
   - 生产环境（客户端）：使用 `/api`（通过Nginx代理）

4. **不要混淆**：
   - SSR环境变量（如`.env.production`）对服务器端fetch无效
   - 必须硬编码完整URL或使用环境判断

**适用场景：**
- 使用Astro SSR模式（`output: 'server'` 或 `output: 'hybrid'`）
- 动态路由页面（如 `[id].astro`、`[slug].astro`）
- 需要服务器端获取数据的页面
- 域名+SSL+Nginx代理架构

**相关文档：**
- Astro SSR文档：https://docs.astro.build/en/guides/server-side-rendering/
- API路由开发文档：第163-180行（SSR环境说明）

---

### 案例7：Sitemap数据不准确（2025-10-14）⚠️ SEO优化必看

**问题描述：**
- Google Search Console显示sitemap有1343个URL
- 但Google实际只索引了932个URL
- 用户反馈sitemap中包含了很多无效链接
- 检查发现marketplace sitemap返回了1000+条数据，但数据库实际只有20条

**根本原因：**
1. **数据来源混乱**：普通的`/api/marketplace` API会返回：
   - 数据库中的20条本地数据
   - 从Chợ Tốt API抓取的1000+条外部数据
2. **外部数据问题**：Chợ Tốt的数据是其他网站的商品，在我们网站上没有对应页面
3. **sitemap使用错误的API**：sitemap直接调用了包含外部数据的API

**技术原理：**

```
错误流程：
sitemap.xml → /api/marketplace （返回数据库+外部API数据）
                      ↓
              包含1000+条外部链接
                      ↓
        Google抓取这些链接全部404
                      ↓
              影响网站SEO评分

正确流程：
sitemap.xml → /api/sitemap/marketplace （只返回数据库数据）
                      ↓
              只包含20条真实页面
                      ↓
        Google成功抓取并索引
```

**影响范围：**
- marketplace sitemap（最严重）
- 其他模块的sitemap也可能有类似问题

**解决方案：**

**1. 创建专用Sitemap API**

在后端创建新的路由文件：

```typescript
// backend/src/routes/sitemap.ts
import { Router } from 'express';
import { asyncHandler } from '../middleware/errorHandler';
import MarketplaceVehicle from '../models/MarketplaceVehicle';
import Car from '../models/Car';
import Motorcycle from '../models/Motorcycle';
import News from '../models/News';

const router = Router();

// 只查询数据库，不包含外部API数据
router.get('/motorcycles', asyncHandler(async (req: any, res: any) => {
  const motorcycles = await Motorcycle.findAll({
    where: { status: 'active' },
    attributes: ['id', 'updated_at', 'created_at'],
    limit: 1000,
  });

  res.json({
    success: true,
    data: motorcycles.map(m => ({
      id: m.id,
      lastmod: m.updated_at || m.created_at,
    })),
  });
}));

// 其他端点类似...
export default router;
```

**2. 注册Sitemap路由**

```typescript
// backend/src/index.ts
import sitemapRoutes from './routes/sitemap';

app.use('/api/sitemap', sitemapRoutes);
```

**3. 更新前端Sitemap生成代码**

```typescript
// frontend/src/pages/sitemap-motorcycles.xml.ts

// ❌ 错误：使用普通API（可能包含外部数据）
const response = await fetch(`${API_URL}/motorcycles`);

// ✅ 正确：使用专用sitemap API（只有数据库数据）
const response = await fetch(`${API_URL}/sitemap/motorcycles`);
```

**4. 实现分割Sitemap**

创建sitemap索引和多个子sitemap：

```typescript
// sitemap-index.xml -> 主索引
//   ├─ sitemap-static.xml (6个静态页面)
//   ├─ sitemap-motorcycles.xml (126条)
//   ├─ sitemap-cars.xml (124条)
//   ├─ sitemap-reviews.xml (89条)
//   └─ sitemap-marketplace.xml (20条，只有数据库数据)
```

**5. 更新robots.txt**

```
# 指向新的sitemap索引
Sitemap: https://vietmoto.top/sitemap-index.xml
```

**6. 重新部署**

```bash
cd /root/越南摩托汽车网站
sudo ./deploy.sh
```

**验证方法：**

```bash
# 1. 测试专用sitemap API
curl http://localhost:4001/api/sitemap/marketplace
# 应该只返回20条左右（数据库数据）

# 2. 对比普通API
curl http://localhost:4001/api/marketplace?limit=1000
# 返回1000+条（包含外部数据）

# 3. 检查sitemap文件
curl http://localhost:4321/sitemap-marketplace.xml | grep -c "<url>"
# 应该是20条左右

# 4. 查看数据库实际数量
sqlite3 /var/www/vietnam-moto-auto/backend/database/vietnam_moto_auto.sqlite \
  "SELECT COUNT(*) FROM marketplace_vehicles WHERE status='active';"
```

**预期结果：**

| 项目 | 修复前 | 修复后 |
|------|--------|--------|
| Sitemap总URL数 | 1343 | ~365 |
| Marketplace URL | 1000+ | ~20 |
| Google索引率 | 69% (932/1343) | ~100% |
| 无效链接 | 400+ | 0 |

**重要提示：**

1. **区分API用途**：
   - 前端展示API：可以包含外部数据（用户可以跳转到外部网站）
   - Sitemap API：只能包含本站真实页面

2. **数据库优先**：
   - Sitemap必须100%基于数据库
   - 不要包含任何外部API数据
   - 不要包含临时数据或缓存数据

3. **定期验证**：
   ```bash
   # 检查sitemap URL数量是否合理
   curl http://localhost:4321/sitemap-index.xml
   
   # 对比数据库实际数量
   sqlite3 vietnam_moto_auto.sqlite "SELECT 
     (SELECT COUNT(*) FROM motorcycles WHERE status='active') as motos,
     (SELECT COUNT(*) FROM cars WHERE status='active') as cars,
     (SELECT COUNT(*) FROM news WHERE status='published') as reviews,
     (SELECT COUNT(*) FROM marketplace_vehicles WHERE status='active') as marketplace;"
   ```

4. **Google Search Console监控**：
   - 提交新sitemap后等待24-48小时
   - 检查"已发现的网页"数量是否匹配
   - 查看是否还有404错误

**适用场景：**
- 使用外部API聚合数据的网站
- 需要精确控制sitemap内容的场景
- SEO优化和Google索引管理
- 数据来源多样化的平台

**相关文档：**
- API路由开发文档：Sitemap模块API章节
- SEO优化文档：Sitemap最佳实践

---

### 案例8：部署脚本覆盖手动修改（2025-10-12）

**问题描述：**
- 手动修改了生产环境的配置文件
- 运行 `deploy.sh` 后，修改被覆盖了

**根本原因：**
- 部署脚本会从源目录复制所有文件
- 生产环境的手动修改会丢失

**正确做法：**

⚠️ **永远修改源文件，不要直接修改生产环境文件！**

```bash
# ✅ 正确：修改源文件
vi /root/越南摩托汽车网站/frontend/astro.config.mjs
vi /root/越南摩托汽车网站/nginx/vietnam-moto-auto.conf

# 然后重新部署
sudo ./deploy.sh

# ❌ 错误：直接修改生产环境
vi /var/www/vietnam-moto-auto/frontend/astro.config.mjs  # 下次部署会被覆盖！
```

**需要修改源文件的配置：**
1. `frontend/astro.config.mjs` - Astro配置
2. `frontend/.env.production` - 前端环境变量
3. `nginx/vietnam-moto-auto.conf` - Nginx配置
4. `backend/.env.production` - 后端环境变量（如果有）
5. `systemd/vietnam-moto-*.service` - Systemd服务配置

---

### 案例9：CSS文件名大小写不匹配导致样式加载失败（2025-10-15）⚠️ 关键问题

**问题描述：**
- 网站打开后完全是白页，所有样式都没有加载
- 浏览器控制台报错：`Refused to apply style from 'https://vietmoto.top/_astro/_slug_.bmmjdtr-.css' because its MIME type ('text/html') is not a supported stylesheet MIME type`
- 错误信息显示 `net::ERR_ABORTED 404 (Not Found)`
- 检查发现CSS文件实际名称是 `_slug_.bmmJdTr-.css`（混合大小写），但浏览器请求的是 `_slug_.bmmjdtr-.css`（全小写）

**问题影响：**
- 🔴 严重性：极高（整个网站无法使用）
- 🔴 用户体验：所有访客看到白页
- 🔴 SEO影响：Google会认为网站有问题
- 🔴 业务影响：完全无法访问

**根本原因分析：**

1. **Astro Hybrid 模式的构建特性**：
   - Vite在构建时会对CSS文件名进行哈希处理
   - 哈希值包含大小写字母（如 `bmmJdTr-`）
   - 服务器端渲染（SSR）会生成包含这些哈希的HTML

2. **浏览器缓存问题**：
   - 用户浏览器可能缓存了旧版本的HTML
   - 旧HTML中引用的CSS文件名可能是小写的
   - 新构建生成的文件名是混合大小写的

3. **Linux文件系统区分大小写**：
   - Linux系统严格区分文件名大小写
   - `bmmJdTr-` 和 `bmmjdtr-` 是两个不同的文件
   - Nginx默认也区分大小写

4. **Nginx配置问题**：
   - 静态资源通过Nginx直接提供（使用alias）
   - Nginx在文件系统中找不到小写文件名
   - 返回404，但content-type是text/html（Nginx的404页面）

**技术细节：**

```bash
# 实际构建产物
/var/www/vietnam-moto-auto/frontend/dist/client/_astro/_slug_.bmmJdTr-.css  ✅ 存在

# 浏览器请求（可能来自缓存的旧HTML）
GET /_astro/_slug_.bmmjdtr-.css  ❌ 404错误

# Nginx配置
location /_astro/ {
    alias /var/www/vietnam-moto-auto/frontend/dist/client/_astro/;
    # 文件系统查找失败 → 404
}
```

**解决方案（三层防护）：**

**临时方案（应急修复）：**
```bash
# 创建小写文件名的符号链接
cd /var/www/vietnam-moto-auto/frontend/dist/client/_astro
ln -sf _slug_.bmmJdTr-.css _slug_.bmmjdtr-.css

# 验证
ls -la | grep slug
# 应该看到：
# lrwxrwxrwx _slug_.bmmjdtr-.css -> _slug_.bmmJdTr-.css
# -rw-r--r-- _slug_.bmmJdTr-.css
```

**永久方案1：在部署脚本中自动处理**

修改 `deploy.sh` 和 `quick-deploy.sh`，在构建完成后自动创建符号链接：

```bash
# 在前端构建完成后添加以下代码

log_info "创建CSS文件名大小写兼容符号链接..."
cd "$TARGET_DIR/frontend/dist/client/_astro"

# 为所有CSS文件创建小写版本的符号链接
for file in *.css; do
    lowercase=$(echo "$file" | tr '[:upper:]' '[:lower:]')
    if [ "$file" != "$lowercase" ]; then
        ln -sf "$file" "$lowercase"
        log_success "创建链接: $lowercase -> $file"
    fi
done

cd -
```

**永久方案2：配置Nginx大小写不敏感**

```nginx
# /etc/nginx/conf.d/vietmoto.conf

# 为_astro目录添加大小写不敏感处理
location ~ ^/_astro/(.*)$ {
    alias /var/www/vietnam-moto-auto/frontend/dist/client/_astro/$1;
    
    # 如果文件不存在，尝试小写版本
    try_files $uri $uri/ =404;
    
    expires 1y;
    add_header Cache-Control "public, immutable";
    access_log off;
}
```

**永久方案3：清理浏览器缓存的机制**

在HTML的`<head>`中添加cache-busting机制：

```html
<!-- 在BaseLayout.astro中 -->
<meta http-equiv="Cache-Control" content="no-cache, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
```

或者使用版本号：

```javascript
// astro.config.mjs
export default defineConfig({
  vite: {
    build: {
      rollupOptions: {
        output: {
          // 使用更简单的哈希策略
          entryFileNames: '_astro/[name].[hash].js',
          chunkFileNames: '_astro/[name].[hash].js',
          assetFileNames: '_astro/[name].[hash][extname]'
        }
      }
    }
  }
});
```

**修复后的部署流程：**

```bash
# 1. 清理旧构建
cd /var/www/vietnam-moto-auto/frontend
rm -rf dist .astro

# 2. 重新构建
npm run build

# 3. 创建符号链接（自动化）
cd dist/client/_astro
for file in *.css *.js; do
    lowercase=$(echo "$file" | tr '[:upper:]' '[:lower:]')
    if [ "$file" != "$lowercase" ]; then
        ln -sf "$file" "$lowercase"
    fi
done

# 4. 重启服务
systemctl restart vietnam-moto-frontend
systemctl reload nginx

# 5. 验证
curl -I https://vietmoto.top/_astro/_slug_.bmmJdTr-.css  # 应该200
curl -I https://vietmoto.top/_astro/_slug_.bmmjdtr-.css  # 也应该200
```

**验证方法：**

```bash
# 1. 检查所有CSS文件
ls -la /var/www/vietnam-moto-auto/frontend/dist/client/_astro/*.css

# 2. 测试所有版本都能访问
curl -I https://vietmoto.top/_astro/_slug_.bmmJdTr-.css
curl -I https://vietmoto.top/_astro/_slug_.bmmjdtr-.css
curl -I https://vietmoto.top/_astro/_slug_.BMMJDTR-.css

# 3. 检查符号链接
ls -la /var/www/vietnam-moto-auto/frontend/dist/client/_astro/ | grep -E "\.css|\.js"

# 4. 浏览器测试
# 打开 https://vietmoto.top
# 按F12查看Network标签
# 确认所有CSS文件都是200状态
```

**预防措施（添加到部署检查清单）：**

1. **部署前检查**：
   ```bash
   # 检查是否有大小写混合的文件名
   find dist/client/_astro -name "*[A-Z]*" -o -name "*[a-z]*"
   ```

2. **自动化测试**：
   ```bash
   # 在deploy.sh中添加CSS加载测试
   log_info "测试CSS文件访问..."
   for css in $(ls dist/client/_astro/*.css | head -3); do
       filename=$(basename "$css")
       if ! curl -f "http://localhost:4321/_astro/$filename" > /dev/null 2>&1; then
           log_error "CSS文件访问失败: $filename"
           exit 1
       fi
   done
   log_success "CSS文件访问测试通过"
   ```

3. **监控告警**：
   ```bash
   # 设置监控脚本
   #!/bin/bash
   # /root/check-css-loading.sh
   
   # 检查CSS 404错误
   css_404=$(tail -100 /var/log/nginx/vietmoto.access.log | grep "\.css" | grep " 404 " | wc -l)
   
   if [ $css_404 -gt 0 ]; then
       echo "警告：检测到 $css_404 个CSS文件404错误"
       # 发送告警通知
   fi
   ```

**根本原因总结：**

这个问题暴露了几个系统性问题：

1. **构建系统不确定性**：Vite的哈希算法可能在不同构建中产生不同大小写
2. **缓存管理不当**：没有有效的缓存失效机制
3. **部署流程不完善**：没有验证资源文件的可访问性
4. **监控缺失**：没有及时发现CSS加载失败

**长期改进计划：**

1. **标准化构建输出**：
   - 配置Vite使用全小写或全大写哈希
   - 或者使用版本号替代哈希

2. **完善部署脚本**：
   - 自动创建大小写兼容的符号链接
   - 添加资源文件访问性测试
   - 部署后自动验证关键CSS文件

3. **改进缓存策略**：
   - 使用版本号管理静态资源
   - 添加强制刷新机制
   - 配置合理的Cache-Control头

4. **监控和告警**：
   - 监控404错误率
   - 监控CSS加载失败
   - 设置告警阈值

**适用场景：**
- 使用Astro或Vite构建的项目
- Linux生产环境（区分大小写）
- 使用Nginx提供静态资源
- 有长期缓存策略的网站

**相关配置文件：**
- `/root/越南摩托汽车网站/deploy.sh` - 需要添加符号链接创建
- `/root/越南摩托汽车网站/quick-deploy.sh` - 需要添加符号链接创建
- `/etc/nginx/conf.d/vietmoto.conf` - Nginx静态资源配置
- `frontend/astro.config.mjs` - Astro构建配置

**重要提示：**

⚠️ **这是一个看似简单但影响巨大的问题**：
- 症状：整个网站白屏
- 原因：一个CSS文件404
- 根源：文件名大小写不匹配
- 教训：细节决定成败

✅ **修复后必须做的事**：
1. 清空所有浏览器缓存
2. 使用隐私模式测试
3. 检查所有CSS文件都能正常加载
4. 更新部署脚本，防止复发

---

## 📝 更新日志

**v4.0.0 (2025-10-15)** 📚 文档整合重大更新
- ✅ **整合三个部署文档为一个统一主文档**
- ✅ 新增完整部署检查清单章节（100+检查项）
- ✅ 整合自动化健康检查工具说明
- ✅ 更新为当前生产环境配置（SSR模式、域名+SSL）
- ✅ 删除重复文档：部署检查清单.md、部署环节系统排查总结.md
- ✅ 统一部署流程和最佳实践
- ✅ 完善常见问题快速修复指南
- ⚠️ 重要：现在只需参考这一个部署文档

**v3.5.0 (2025-10-15)** 🔴 关键更新
- ✅ **修复CSS文件名大小写不匹配问题（案例9）**
- ✅ 添加自动创建符号链接机制
- ✅ 更新部署脚本防止CSS加载失败
- ✅ 添加CSS文件访问性测试
- ✅ 完善Nginx静态资源配置
- ✅ 添加监控和告警机制
- ⚠️ 这是一个严重影响用户体验的关键修复

**v3.4.0 (2025-10-14 下午)**
- ✅ 新增Sitemap数据不准确问题案例（案例7）
- ✅ 添加专用Sitemap API创建指南
- ✅ 完善SEO sitemap最佳实践文档
- ✅ 添加数据来源验证方法
- ✅ 更新Google索引优化建议

**v3.3.0 (2025-10-14 下午)**
- ✅ 新增SSR详情页修复完整案例（案例6）
- ✅ 修复5个详情页SSR渲染问题
- ✅ 区分服务器端和客户端API调用方式
- ✅ 添加SSR环境API调用最佳实践
- ✅ 更新prerender配置说明
- ✅ 完善SSR和CSR请求流程对比

**v3.2.0 (2025-10-14 上午)**
- ✅ 新增域名+SSL部署完整案例（案例5）
- ✅ 修复HTTPS混合内容错误（Mixed Content）
- ✅ 修复11个前端文件的API调用路径
- ✅ 添加域名+SSL部署检查脚本
- ✅ 更新部署脚本：自动删除.env.production
- ✅ 完善前端API路径使用规范
- ✅ 新增SSL部署最佳实践文档

**v3.1.0 (2025-10-14)**
- ✅ 新增 `pre-deploy-check.sh` 部署前检查脚本
- ✅ 修复前端构建检查（支持 Astro Hybrid 模式）
- ✅ 新增数据库表结构自动同步功能
- ✅ 自动验证 marketplace_vehicles 和 reviews 表
- ✅ 修正开发环境数据库路径
- ✅ 完善 `quick-deploy.sh` 健康检查
- ✅ 支持 dist/client 和 dist/server 结构
- ✅ 完善错误处理和回滚机制

**v2.1 (2025-10-12 下午)**
- ✅ 修复前端服务未自动启动问题
- ✅ 添加前端服务健康检查
- ✅ 修复Nginx配置冲突问题
- ✅ 更新访问地址说明（4321为主要端口）
- ✅ 添加部署问题案例文档
- ✅ 清理cryptopulse配置文件

**v2.0 (2025-10-12 上午)**
- ✅ 彻底重写部署脚本
- ✅ 添加三重数据库保护机制
- ✅ 实现自动回滚功能
- ✅ 添加完整的验证检查
- ✅ 改用tar替代rsync（不依赖外部工具）
- ✅ 优化12步部署流程

**v1.0 (2025-10-11)**
- 初始版本
- 基础部署功能
- MySQL到SQLite迁移

---

**最后更新**：2025年10月15日  
**文档版本**：v4.0.0（文档整合版）  
**维护者**：开发团队  
**重要说明**：本文档整合了原有的三个部署文档，现在是唯一的部署参考文档

---

## 🔐 域名+SSL部署指南

### 域名和SSL部署与IP部署的区别

**IP地址部署（HTTP）：**
```bash
前端: http://47.237.79.9:4321
后端: http://47.237.79.9:4001
特点: 可以使用环境变量配置后端地址
```

**域名+SSL部署（HTTPS）：**
```bash
前端: https://vietmoto.top
后端: https://vietmoto.top/api (通过Nginx代理)
特点: 必须使用相对路径，所有API通过Nginx代理
```

### 域名+SSL部署检查清单

**部署前检查：**
- [ ] 域名已解析到服务器IP
- [ ] SSL证书已申请并配置
- [ ] Nginx已配置HTTPS和API代理
- [ ] 删除所有前端 `.env*` 文件
- [ ] 检查前端代码无硬编码HTTP地址

**检查命令：**
```bash
# 1. 检查域名解析
nslookup vietmoto.top

# 2. 检查SSL证书
openssl s_client -connect vietmoto.top:443 -servername vietmoto.top < /dev/null

# 3. 检查Nginx配置
nginx -t
grep -A 10 "location /api" /etc/nginx/conf.d/*.conf

# 4. 检查前端环境变量
ls -la /root/越南摩托汽车网站/frontend/.env*

# 5. 检查硬编码地址
cd /root/越南摩托汽车网站/frontend
grep -r "localhost:4001\|47\.237\.79\.9" src/
```

### 常见错误和解决

**错误1：Mixed Content**
```
原因：HTTPS页面请求HTTP资源
解决：使用相对路径 /api，通过Nginx代理
```

**错误2：API返回404**
```
原因：Nginx未正确配置API代理
解决：检查 location /api/ 配置
```

**错误3：SSL证书错误**
```
原因：证书过期或域名不匹配
解决：重新申请证书或检查域名配置
```

### 部署流程（域名+SSL）

```bash
# 1. 删除环境变量文件
rm -f /root/越南摩托汽车网站/frontend/.env*

# 2. 检查API路径
cd /root/越南摩托汽车网站/frontend
grep -r "localhost:4001\|47\.237\.79\.9" src/
# 应该无结果

# 3. 正常部署
cd /root/越南摩托汽车网站
sudo ./deploy.sh

# 4. 验证
curl https://vietmoto.top/api/health
curl https://vietmoto.top/
```
