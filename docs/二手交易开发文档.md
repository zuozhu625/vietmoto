# 二手交易模块开发文档

## 📋 目录

1. [模块概述](#模块概述)
2. [技术架构](#技术架构)
3. [数据来源](#数据来源)
4. [数据库设计](#数据库设计)
5. [后端实现](#后端实现)
6. [前端实现](#前端实现)
7. [部署配置](#部署配置)
8. [API接口文档](#api接口文档)
9. [数据同步机制](#数据同步机制)
10. [注意事项](#注意事项)

---

## 模块概述

### 功能描述
二手交易模块为用户提供越南二手摩托车和汽车的交易信息展示平台。通过集成Chợ Tốt（越南领先的二手交易平台）的公开API，自动抓取并展示最新的二手车辆信息。

### 核心功能
- ✅ 自动抓取Chợ Tốt平台的二手车辆信息
- ✅ 只展示最近3周内发布的新鲜数据
- ✅ **四种车辆类型筛选**：燃油摩托车、电动摩托车、燃油汽车、电动汽车
- ✅ **智能分类系统**：基于关键词自动识别燃油/电动车辆
- ✅ **年份提取功能**：从标题中智能提取车辆年份信息
- ✅ 支持车辆列表浏览和分页
- ✅ **按年份排序**：支持最新/最旧年份排序
- ✅ 提供详细的车辆信息页面（SSR渲染）
- ✅ 一键跳转到原始平台联系卖家
- ✅ 每日自动同步更新数据
- ✅ **现代化毛玻璃UI设计**

### 技术亮点
- **数据时效性**：只保留最近3周的数据，确保信息新鲜度
- **SSR渲染**：详情页采用服务端渲染，SEO友好
- **混合渲染**：列表页静态预渲染，详情页动态渲染
- **自动化同步**：通过定时任务自动更新数据
- **智能分类**：基于关键词自动识别燃油/电动车辆类型
- **年份提取**：从标题中智能提取车辆年份，支持年份排序
- **数据重新分类**：支持对现有数据进行智能重新分类
- **Cursor风格UI**：毛玻璃效果、立体感、高质感设计

---

## 技术架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户浏览器                              │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                    Nginx (反向代理)                           │
│  - 静态文件服务                                               │
│  - API请求代理到后端 (4001)                                   │
│  - SSR请求代理到Astro服务器 (4321)                            │
└────────────┬───────────────────────────┬────────────────────┘
             │                           │
             ▼                           ▼
┌────────────────────────┐    ┌──────────────────────────────┐
│  Astro SSR Server      │    │   Node.js Backend API        │
│  (Port 4321)           │    │   (Port 4001)                │
│  - 详情页动态渲染       │    │   - RESTful API              │
│  - 列表页静态预渲染     │    │   - 数据同步服务             │
│  - 四种类型筛选         │    │   - 多分类数据抓取           │
└────────────┬───────────┘    └──────────┬───────────────────┘
             │                           │
             │                           ▼
             │                ┌─────────────────────────────┐
             │                │   SQLite Database           │
             │                │   - marketplace_vehicles表   │
             └────────────────┤   - vehicle_type字段支持4种  │
                              └─────────────────────────────┘
                                         ▲
                                         │
                              ┌──────────┴──────────────────┐
                              │  Chợ Tốt Public API         │
                              │  - 车辆列表API               │
                              │  - 摩托车分类: 2020          │
                              │  - 汽车分类: 2010            │
                              └─────────────────────────────┘
```

### 技术栈

#### 前端
- **框架**: Astro 5.14.4 (混合渲染模式 - Hybrid)
- **UI库**: React 18
- **样式**: 
  - CSS Module (MarketplaceList.css)
  - Astro Scoped Styles
  - 全局样式系统 (global.css)
- **适配器**: @astrojs/node (standalone模式)
- **渲染模式**: 混合渲染 (Hybrid Rendering)
  - 列表页: 静态预渲染 (prerender: true)
  - 详情页: 服务端渲染 (prerender: false)
- **设计风格**: Cursor风格 - 毛玻璃、渐变、立体感

#### 后端
- **运行时**: Node.js 20.x
- **框架**: Express.js
- **语言**: TypeScript
- **ORM**: Sequelize
- **数据库**: SQLite
- **HTTP客户端**: Axios
- **定时任务**: node-cron

---

## 数据来源

### Chợ Tốt API

#### API端点
```
https://gateway.chotot.com/v1/public/ad-listing
```

**⚠️ 重要说明**：
- Chợ Tốt API使用HTTPS
- 后端同步数据时直接访问外部API（HTTPS）
- 不受本地域名+SSL配置影响
- 后端运行在内网HTTP环境，但可以正常请求外部HTTPS API

#### 车辆分类映射
```typescript
const categories = {
  'moto-gas': '2020',      // 燃油摩托车
  'moto-electric': '2020', // 电动摩托车 (同分类，通过其他字段区分)
  'car-gas': '2010',       // 燃油汽车
  'car-electric': '2010',  // 电动汽车 (同分类，通过其他字段区分)
};
```

#### 请求参数
| 参数 | 类型 | 说明 | 示例值 |
|------|------|------|--------|
| cg | string | 分类ID | 2020 (摩托车) / 2010 (汽车) |
| st | string | 状态类型 | s,k (出售中) |
| limit | number | 返回数量 | 20 |
| o | number | 偏移量 | 0 |

#### 响应数据结构
```typescript
interface ChoTotResponse {
  total: number;
  ads: ChoTotAd[];
}

interface ChoTotAd {
  ad_id: number;              // 广告ID
  subject: string;            // 标题
  body: string;               // 描述
  price: number;              // 价格
  image: string;              // 主图
  images: string[];           // 图片列表
  motorbikebrand?: number;    // 品牌ID
  regdate?: number;           // 注册年份
  mileage_v2?: number;        // 里程数
  condition_ad?: number;      // 车况
  condition_ad_name?: string; // 车况描述
  region_name?: string;       // 省/市
  area_name?: string;         // 区
  ward_name?: string;         // 街道
  full_name?: string;         // 卖家姓名
  account_id?: number;        // 卖家ID
  avatar?: string;            // 卖家头像
  average_rating?: number;    // 卖家评分
  sold_ads?: number;          // 已售数量
  list_time?: number;         // 发布时间(毫秒时间戳)
  status?: string;            // 状态
}
```

#### 品牌映射表
```typescript
const brands: Record<number, string> = {
  1: 'Honda',
  2: 'Yamaha',
  3: 'Piaggio',
  4: 'Suzuki',
  5: 'SYM',
  6: 'Aprilia',
  9: 'BMW',
  12: 'Ducati',
  17: 'Kawasaki',
  20: 'KTM',
  21: 'Kymco',
};
```

### 数据过滤规则

#### 时间过滤
- **规则**: 只保留最近3周（21天）内发布的数据
- **实现**: 
  ```typescript
  const threeWeeksAgo = Date.now() - (21 * 24 * 60 * 60 * 1000);
  const recentAds = ads.filter(ad => {
    if (!ad.list_time) return false;
    const adTime = ad.list_time * 1000;
    return adTime >= threeWeeksAgo;
  });
  ```

#### 数据量控制
- **每次同步**: 每种类型50条数据
- **API请求**: 150条（limit * 3），过滤后取前50条
- **总数据量**: 4种类型 × 50 = 200条
- **原因**: 确保过滤后有足够的有效数据

---

## 数据库设计

### 表结构: marketplace_vehicles

```sql
CREATE TABLE IF NOT EXISTS marketplace_vehicles (
    -- 主键和外部标识
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    external_id TEXT UNIQUE NOT NULL,           -- Chợ Tốt的广告ID
    external_url TEXT,                          -- 原始链接
    source TEXT DEFAULT 'chotot',               -- 数据来源
    
    -- 车辆分类信息 (新增)
    type TEXT DEFAULT 'motorcycle',             -- 大类: motorcycle/car
    vehicle_type TEXT DEFAULT 'moto-gas',       -- 细分类型: moto-gas/moto-electric/car-gas/car-electric
    
    -- 车辆基本信息
    brand TEXT,                                 -- 品牌
    model TEXT,                                 -- 型号
    year INTEGER,                               -- 年份
    price REAL NOT NULL,                        -- 价格
    title TEXT NOT NULL,                        -- 标题
    description TEXT,                           -- 描述
    mileage INTEGER,                            -- 里程数
    
    -- 车况信息
    condition_text TEXT,                        -- 车况描述
    condition_rating INTEGER,                   -- 车况评分(1-5)
    
    -- 图片信息
    image_url TEXT,                             -- 主图URL
    images TEXT,                                -- 图片列表(JSON字符串)
    
    -- 位置信息
    city TEXT,                                  -- 城市
    district TEXT,                              -- 区
    ward TEXT,                                  -- 街道
    location TEXT,                              -- 坐标
    
    -- 卖家信息
    seller_name TEXT,                           -- 卖家姓名
    seller_id TEXT,                             -- 卖家ID
    seller_avatar TEXT,                         -- 卖家头像
    seller_phone TEXT,                          -- 卖家电话
    seller_rating REAL,                         -- 卖家评分
    seller_sold_count INTEGER DEFAULT 0,        -- 已售数量
    
    -- 统计信息
    view_count INTEGER DEFAULT 0,               -- 浏览次数
    favorites_count INTEGER DEFAULT 0,          -- 收藏次数
    
    -- 状态和标记
    status TEXT DEFAULT 'active',               -- 状态: active/inactive
    is_featured BOOLEAN DEFAULT 0,              -- 是否精选
    
    -- 时间戳
    published_at DATETIME,                      -- 发布时间
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX IF NOT EXISTS idx_marketplace_external_id ON marketplace_vehicles(external_id);
CREATE INDEX IF NOT EXISTS idx_marketplace_status ON marketplace_vehicles(status);
CREATE INDEX IF NOT EXISTS idx_marketplace_published_at ON marketplace_vehicles(published_at);
CREATE INDEX IF NOT EXISTS idx_marketplace_vehicle_type ON marketplace_vehicles(vehicle_type);  -- 新增
CREATE INDEX IF NOT EXISTS idx_marketplace_brand ON marketplace_vehicles(brand);
CREATE INDEX IF NOT EXISTS idx_marketplace_city ON marketplace_vehicles(city);
```

### 关键字段说明

#### vehicle_type（新增核心字段）
- **类型**: TEXT
- **作用**: 区分四种车辆类型
- **可选值**:
  - `moto-gas`: 燃油摩托车
  - `moto-electric`: 电动摩托车
  - `car-gas`: 燃油汽车
  - `car-electric`: 电动汽车
- **用途**: 前端筛选标签的数据源

#### 其他关键字段
- **external_id**: Chợ Tốt的广告ID，用于去重和更新
- **images**: JSON字符串，存储多张图片URL
- **seller_phone**: 卖家电话信息
- **published_at**: 用于时间过滤，只保留最近3周的数据

---

## 后端实现

### 目录结构

```
backend/
├── src/
│   ├── models/
│   │   └── MarketplaceVehicle.ts          # Sequelize模型 (含vehicle_type字段)
│   ├── services/
│   │   ├── ChoTotService.ts               # Chợ Tốt API服务 (支持4种类型)
│   │   └── MarketplaceScheduler.ts        # 定时同步任务
│   ├── routes/
│   │   └── marketplace.ts                 # API路由 (支持vehicle_type筛选)
│   └── index.ts                           # 主入口
├── database/
│   └── init-marketplace-table.sql         # 数据库初始化脚本
└── package.json
```

### 核心服务: ChoTotService.ts

#### 主要功能
1. **多类型数据抓取**: 支持4种车辆类型的独立抓取
2. **智能分类系统**: 基于关键词自动识别燃油/电动车辆
3. **年份提取功能**: 从标题中智能提取车辆年份信息
4. **数据过滤**: 只保留最近3周的数据
5. **数据转换**: 将API数据转换为数据库模型
6. **数据保存**: 使用upsert避免重复
7. **数据重新分类**: 支持对现有数据进行智能重新分类

#### 关键代码

```typescript
class ChoTotService {
  private baseUrl = 'https://gateway.chotot.com/v1/public/ad-listing';
  
  // 分类ID映射
  private categories = {
    'moto-gas': '2020',      // 燃油摩托车
    'moto-electric': '2020', // 电动摩托车
    'car-gas': '2010',       // 燃油汽车
    'car-electric': '2010',  // 电动汽车
  };
  
  /**
   * 获取车辆列表（只获取最近3周的数据）
   * @param vehicleType - 车辆类型
   * @param limit - 需要的数量
   */
  async fetchVehicles(vehicleType: string, limit: number = 50): Promise<ChoTotAd[]> {
    const category = this.categories[vehicleType] || '2020';
    
    const response = await axios.get(this.baseUrl, {
      params: {
        cg: category,
        st: 's,k',
        limit: limit * 3, // 多获取以确保过滤后有足够数据
        o: 0,
      },
      headers: {
        'User-Agent': 'Mozilla/5.0...',
        'Accept': 'application/json',
      },
      timeout: 15000,
    });
    
    // 时间过滤
    const threeWeeksAgo = Date.now() - (21 * 24 * 60 * 60 * 1000);
    const recentAds = response.data.ads.filter(ad => {
      if (!ad.list_time) return false;
      const adTime = ad.list_time * 1000;
      return adTime >= threeWeeksAgo;
    }).slice(0, limit);
    
    return recentAds;
  }
  
  /**
   * 从标题中提取年份
   * @param title - 车辆标题
   * @returns 提取到的年份，如果没有则返回null
   */
  private extractYearFromTitle(title: string): number | null {
    if (!title) return null;
    
    // 匹配4位数字年份 (1990-2030)
    const yearMatch = title.match(/\b(19[9]\d|20[0-2]\d|2030)\b/);
    if (yearMatch) {
      const year = parseInt(yearMatch[1]);
      if (year >= 1990 && year <= 2030) {
        return year;
      }
    }
    
    return null;
  }
  
  /**
   * 智能判断车辆类型（燃油 vs 电动）
   * @param ad - 广告数据
   * @param requestedType - 请求的类型
   * @returns 实际应该分类的类型
   */
  private determineVehicleType(ad: ChoTotAd, requestedType: string): string {
    const title = (ad.subject || '').toLowerCase();
    const description = (ad.body || '').toLowerCase();
    const text = `${title} ${description}`;
    
    // 电动关键词
    const electricKeywords = [
      'điện', 'electric', 'e-', 'ev', 'xe điện', 'xe máy điện', 'ô tô điện',
      'pin', 'battery', 'sạc', 'charging', 'hybrid', 'híbrido'
    ];
    
    // 燃油关键词
    const gasKeywords = [
      'xăng', 'gas', 'petrol', 'diesel', 'dầu', 'nhiên liệu', 'động cơ',
      'máy', 'engine', 'cc', 'cm3', 'phân khối'
    ];
    
    const hasElectricKeywords = electricKeywords.some(keyword => 
      text.includes(keyword.toLowerCase())
    );
    const hasGasKeywords = gasKeywords.some(keyword => 
      text.includes(keyword.toLowerCase())
    );
    
    // 根据请求类型和关键词判断
    if (requestedType.startsWith('moto')) {
      if (hasElectricKeywords && !hasGasKeywords) {
        return 'moto-electric';
      } else if (hasGasKeywords && !hasElectricKeywords) {
        return 'moto-gas';
      } else {
        return requestedType;
      }
    } else if (requestedType.startsWith('car')) {
      if (hasElectricKeywords && !hasGasKeywords) {
        return 'car-electric';
      } else if (hasGasKeywords && !hasElectricKeywords) {
        return 'car-gas';
      } else {
        return requestedType;
      }
    }
    
    return requestedType;
  }
  
  /**
   * 保存到数据库
   */
  async saveToDatabase(ads: ChoTotAd[], vehicleType: string): Promise<number> {
    let savedCount = 0;
    
    for (const ad of ads) {
      // 智能判断实际车辆类型
      const actualVehicleType = this.determineVehicleType(ad, vehicleType);
      const isMotorcycle = actualVehicleType.startsWith('moto');
      
      // 从标题中提取年份
      const extractedYear = this.extractYearFromTitle(ad.subject);
      const finalYear = ad.regdate || extractedYear || undefined;
      
      console.log(`🔍 车辆分类: ${ad.subject} -> ${vehicleType} -> ${actualVehicleType}, 年份: ${finalYear}`);
      
      const data = {
        external_id: ad.ad_id.toString(),
        external_url: `https://xe.chotot.com/${ad.ad_id}`,
        type: isMotorcycle ? 'motorcycle' : 'car',
        vehicle_type: actualVehicleType, // 使用智能判断的结果
        brand: this.getBrandName(ad.motorbikebrand),
        year: finalYear, // 使用提取的年份
        price: ad.price,
        title: ad.subject,
        description: ad.body,
        mileage: ad.mileage_v2,
        condition_text: ad.condition_ad_name,
        image_url: ad.image,
        images: JSON.stringify(ad.images || []),
        city: ad.region_name,
        district: ad.area_name,
        seller_name: ad.full_name,
        seller_rating: ad.average_rating,
        published_at: new Date(ad.list_time),
        // ... 其他字段
      };
      
      await MarketplaceVehicle.upsert(data);
      savedCount++;
      
      // 延迟避免请求过快
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    return savedCount;
  }
  
  /**
   * 重新分类现有数据
   */
  async reclassifyExistingData(): Promise<{ processed: number; updated: number }> {
    console.log('\n🔄 开始重新分类现有数据...');
    const vehicles = await MarketplaceVehicle.findAll({
      where: { status: 'active' },
      attributes: ['id', 'title', 'description', 'vehicle_type', 'external_id']
    });
    
    let processed = 0;
    let updated = 0;
    
    for (const vehicle of vehicles) {
      try {
        const ad: ChoTotAd = {
          ad_id: parseInt(vehicle.external_id),
          subject: vehicle.title,
          body: vehicle.description || '',
          price: 0,
          image: '',
          images: [],
        };
        
        // 智能判断正确的类型
        const correctType = this.determineVehicleType(ad, vehicle.vehicle_type);
        
        // 从标题中提取年份
        const extractedYear = this.extractYearFromTitle(vehicle.title);
        const finalYear = vehicle.year || extractedYear || undefined;
        
        // 检查是否需要更新
        const needsUpdate = correctType !== vehicle.vehicle_type || finalYear !== vehicle.year;
        
        if (needsUpdate) {
          const updateData: any = {};
          if (correctType !== vehicle.vehicle_type) {
            updateData.vehicle_type = correctType;
          }
          if (finalYear !== vehicle.year) {
            updateData.year = finalYear;
          }
          
          await vehicle.update(updateData);
          console.log(`✅ 重新分类: ${vehicle.title} -> ${vehicle.vehicle_type} -> ${correctType}, 年份: ${vehicle.year} -> ${finalYear}`);
          updated++;
        }
        
        processed++;
      } catch (error: any) {
        console.error(`❌ 重新分类失败 ${vehicle.id}:`, error.message);
      }
    }
    
    console.log(`\n📊 重新分类完成: 处理 ${processed} 条, 更新 ${updated} 条\n`);
    return { processed, updated };
  }
  
  /**
   * 同步所有分类的数据
   */
  async fetchAndSaveAll(limitPerType: number = 50): Promise<Record<string, any>> {
    const types = ['moto-gas', 'moto-electric', 'car-gas', 'car-electric'];
    const results: Record<string, any> = {};
    
    for (const type of types) {
      results[type] = await this.fetchAndSaveByType(type, limitPerType);
      // 分类之间延迟
      await new Promise(resolve => setTimeout(resolve, 2000));
    }
    
    return results;
  }
}
```

### API路由: marketplace.ts

#### 端点列表

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/marketplace` | 获取车辆列表(分页、筛选、排序) |
| GET | `/api/marketplace/:id` | 获取车辆详情 |
| POST | `/api/marketplace/sync` | 手动触发同步 |
| POST | `/api/marketplace/reclassify` | 重新分类现有数据 |
| GET | `/api/marketplace/stats/summary` | 获取统计信息 |

#### 筛选支持

```typescript
router.get('/', async (req: Request, res: Response) => {
  const {
    page = '1',
    limit = '12',
    vehicle_type, // 关键：支持vehicle_type筛选
    brand,
    minPrice,
    maxPrice,
    city,
    sort = 'year_desc', // 默认按年份最新排序
  } = req.query;
  
  const where: any = { status: 'active' };
  
  // 按vehicle_type筛选
  if (vehicle_type) {
    where.vehicle_type = vehicle_type; // moto-gas, moto-electric等
  }
  
  if (brand) where.brand = brand;
  if (minPrice || maxPrice) where.price = { /* 价格范围 */ };
  
  // 排序 - 默认按年份最新排序，年份为空时按发布时间排序
  let order: any[] = [
    ['year', 'DESC NULLS LAST'], // 年份最新，空值排在最后
    ['published_at', 'DESC']      // 发布时间最新
  ];
  if (sort === 'price_asc') order = [['price', 'ASC']];
  if (sort === 'price_desc') order = [['price', 'DESC']];
  if (sort === 'popular') order = [['view_count', 'DESC']];
  if (sort === 'year_desc') order = [['year', 'DESC NULLS LAST'], ['published_at', 'DESC']]; // 年份最新
  if (sort === 'year_asc') order = [['year', 'ASC NULLS LAST'], ['published_at', 'DESC']]; // 年份最旧
  if (sort === 'latest') order = [['published_at', 'DESC']]; // 最新发布
  
  const { rows, count } = await MarketplaceVehicle.findAndCountAll({
    where,
    order,
    limit: parseInt(limit),
    offset: (parseInt(page) - 1) * parseInt(limit),
  });
  
  res.json({
    success: true,
    data: rows,
    pagination: { /* ... */ },
  });
});
```

---

## 前端实现

### 目录结构

```
frontend/
├── src/
│   ├── pages/
│   │   └── marketplace/
│   │       ├── index.astro              # 列表页(静态预渲染)
│   │       └── [id].astro               # 详情页(SSR)
│   ├── components/
│   │   ├── MarketplaceList.tsx          # 列表组件 (支持4种类型筛选)
│   │   └── MarketplaceList.css          # 组件样式 (毛玻璃效果)
│   ├── services/
│   │   └── marketplaceApi.ts            # API调用封装
│   └── styles/
│       └── global.css                   # 全局样式系统
└── astro.config.mjs                     # Astro配置
```

### 列表页: marketplace/index.astro

#### 特点
- **静态预渲染**: 构建时生成HTML
- **客户端交互**: React组件处理筛选和分页
- **SEO友好**: 完整的HTML结构
- **现代化UI**: Hero区域 + 筛选标签

#### 代码结构

```astro
---
export const prerender = true; // 预渲染为静态页面

import BaseLayout from '../../layouts/BaseLayout.astro';
import MarketplaceList from '../../components/MarketplaceList';
---

<BaseLayout 
  title="Mua Bán Xe Máy Cũ - Vietnam Moto & Auto"
  description="Tìm kiếm và mua bán xe máy cũ giá tốt tại Việt Nam."
>
  <!-- Hero Section -->
  <section class="marketplace-hero">
    <div class="container-fluid">
      <div class="hero-content">
        <h1 class="hero-title">🏍️ Chợ Xe Cũ</h1>
        <p class="hero-description">
          Tìm kiếm xe cũ chất lượng với giá tốt nhất. 
          Dữ liệu được cập nhật tự động từ Chợ Tốt.
        </p>
      </div>
    </div>
  </section>

  <!-- Marketplace List with Tabs -->
  <section style="padding: 0 0 var(--spacing-4xl) 0;">
    <div class="container-fluid">
      <MarketplaceList client:load />
    </div>
  </section>
</BaseLayout>

<style>
  .marketplace-hero {
    padding: var(--spacing-3xl) 0 var(--spacing-2xl) 0;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    border-bottom: 1px solid var(--glass-border);
  }
  
  .hero-title {
    font-size: 3rem;
    font-weight: 800;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  /* ... 更多样式 */
</style>
```

### 列表组件: MarketplaceList.tsx

#### 核心功能
- **四种类型筛选标签**: 燃油摩托车、电动摩托车、燃油汽车、电动汽车
- **动态数据加载**: 根据选中的标签动态获取数据
- **分页支持**: 翻页功能
- **响应式布局**: 自适应不同屏幕尺寸

#### 关键代码

```typescript
import { useState, useEffect } from 'react';
import { getMarketplaceList, formatPrice } from '../services/marketplaceApi';
import './MarketplaceList.css'; // 导入样式

type VehicleType = 'moto-gas' | 'moto-electric' | 'car-gas' | 'car-electric';

export default function MarketplaceList() {
  const [vehicles, setVehicles] = useState<MarketplaceVehicle[]>([]);
  const [loading, setLoading] = useState(true);
  const [page, setPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const [activeTab, setActiveTab] = useState<VehicleType>('moto-gas');

  useEffect(() => {
    fetchVehicles();
  }, [page, activeTab]);

  const fetchVehicles = async () => {
    setLoading(true);
    const response = await getMarketplaceList({ 
      page, 
      limit: 12,
      vehicle_type: activeTab  // 关键：按类型筛选
    });
    setVehicles(response.data);
    setTotalPages(response.pagination.totalPages);
    setLoading(false);
  };

  const handleTabChange = (tab: VehicleType) => {
    setActiveTab(tab);
    setPage(1); // 切换标签时重置页码
  };

  return (
    <div className="marketplace-container">
      {/* 四个筛选标签 */}
      <div className="vehicle-tabs">
        <button
          className={`tab-button ${activeTab === 'moto-gas' ? 'active' : ''}`}
          onClick={() => handleTabChange('moto-gas')}
        >
          🏍️ Xe máy xăng
        </button>
        <button
          className={`tab-button ${activeTab === 'moto-electric' ? 'active' : ''}`}
          onClick={() => handleTabChange('moto-electric')}
        >
          ⚡ Xe máy điện
        </button>
        <button
          className={`tab-button ${activeTab === 'car-gas' ? 'active' : ''}`}
          onClick={() => handleTabChange('car-gas')}
        >
          🚗 Ô tô xăng
        </button>
        <button
          className={`tab-button ${activeTab === 'car-electric' ? 'active' : ''}`}
          onClick={() => handleTabChange('car-electric')}
        >
          🔋 Ô tô điện
        </button>
      </div>

      {/* 车辆列表 */}
      <div className="marketplace-grid">
        {vehicles.map((vehicle) => (
          <a 
            key={vehicle.id} 
            href={`/marketplace/${vehicle.id}`}
            className="marketplace-card"
          >
            <div className="card-image-wrapper">
              <img src={vehicle.image_url} alt={vehicle.title} />
              {vehicle.condition_text && (
                <span className="condition-badge">
                  {vehicle.condition_text}
                </span>
              )}
            </div>
            
            <div className="card-content">
              <h3 className="card-title">{vehicle.title}</h3>
              <div className="card-price">{formatPrice(vehicle.price)}</div>
              <div className="card-location">
                📍 {vehicle.district}, {vehicle.city}
              </div>
              {/* ... 更多信息 */}
            </div>
          </a>
        ))}
      </div>

      {/* 分页 */}
      <div className="pagination">
        <button onClick={() => setPage(p => Math.max(1, p - 1))}>
          ← Trang trước
        </button>
        <span>Trang {page} / {totalPages}</span>
        <button onClick={() => setPage(p => Math.min(totalPages, p + 1))}>
          Trang sau →
        </button>
      </div>
    </div>
  );
}
```

### 组件样式: MarketplaceList.css

#### 设计特色
- **毛玻璃效果**: backdrop-filter + 半透明背景
- **渐变高亮**: 紫蓝渐变作为主题色
- **立体悬浮**: 3D变换和阴影
- **响应式布局**: 桌面4列、平板2列、手机1列

#### 核心样式

```css
/* 筛选标签 - 毛玻璃效果 */
.vehicle-tabs {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--spacing-lg);
  margin-bottom: var(--spacing-3xl);
}

.tab-button {
  position: relative;
  padding: var(--spacing-xl) var(--spacing-lg);
  background: var(--glass-bg);                    /* 半透明背景 */
  border: 2px solid var(--glass-border);
  border-radius: var(--radius-xl);
  color: var(--text-primary);
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);                    /* 毛玻璃模糊 */
  overflow: hidden;
}

/* 渐变叠加层 */
.tab-button::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
  opacity: 0;
  transition: opacity 0.4s ease;
}

.tab-button:hover::before {
  opacity: 1;
}

/* 悬浮效果 */
.tab-button:hover {
  border-color: rgba(102, 126, 234, 0.5);
  transform: translateY(-4px);                    /* 上浮 */
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
}

/* 激活状态 - 紫蓝渐变 */
.tab-button.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-color: transparent;
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 12px 32px rgba(102, 126, 234, 0.5);
}

/* 响应式布局 */
@media (max-width: 968px) {
  .vehicle-tabs {
    grid-template-columns: repeat(2, 1fr);        /* 平板：2列 */
  }
}

@media (max-width: 480px) {
  .vehicle-tabs {
    grid-template-columns: 1fr;                   /* 手机：1列 */
  }
}
```

### API服务: marketplaceApi.ts

#### 封装的API函数

**⚠️ 生产环境配置（域名+SSL）**：
```typescript
// ✅ 正确：使用相对路径（域名+SSL环境）
const API_BASE_URL = '/api';

// ❌ 错误：硬编码HTTP地址
// const API_BASE_URL = 'http://47.237.79.9:4001/api';
// const API_BASE_URL = import.meta.env.PUBLIC_API_URL || 'http://...';

/**
 * 获取二手车辆列表
 * @param params.vehicle_type - 车辆类型筛选
 */
export async function getMarketplaceList(params: {
  page?: number;
  limit?: number;
  vehicle_type?: string; // moto-gas | moto-electric | car-gas | car-electric
  brand?: string;
  minPrice?: number;
  maxPrice?: number;
  city?: string;
} = {}): Promise<MarketplaceListResponse> {
  // API_BASE_URL = '/api' - 相对路径，自动通过Nginx代理为HTTPS
  const response = await axios.get(`${API_BASE_URL}/marketplace`, { params });
  return response.data;
}

/**
 * 格式化价格（越南盾）
 */
export function formatPrice(price: number): string {
  return new Intl.NumberFormat('vi-VN', {
    style: 'currency',
    currency: 'VND',
    maximumFractionDigits: 0,
  }).format(price);
}

/**
 * 格式化里程数
 */
export function formatMileage(mileage?: number): string {
  if (!mileage) return 'Chưa rõ';
  if (mileage < 1000) return `${mileage} km`;
  return `${(mileage / 1000).toFixed(1)} nghìn km`;
}

/**
 * 格式化时间
 */
export function formatDate(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diff = now.getTime() - date.getTime();
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  
  if (days === 0) return 'Hôm nay';
  if (days === 1) return 'Hôm qua';
  if (days < 7) return `${days} ngày trước`;
  
  return date.toLocaleDateString('vi-VN');
}
```

---

## 部署配置

### Systemd服务配置

#### 后端服务: vietnam-moto-backend.service

```ini
[Unit]
Description=Vietnam Moto Auto Backend Service
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/var/www/vietnam-moto-auto/backend
Environment=NODE_ENV=production
Environment=PORT=4001
ExecStart=/usr/bin/node dist/index.js
Restart=always
RestartSec=10
StandardOutput=append:/var/www/vietnam-moto-auto/backend/logs/backend.log
StandardError=append:/var/www/vietnam-moto-auto/backend/logs/backend-error.log

[Install]
WantedBy=multi-user.target
```

#### 前端服务: vietnam-moto-frontend.service

```ini
[Unit]
Description=Vietnam Moto Auto Frontend Service
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/var/www/vietnam-moto-auto/frontend
Environment=NODE_ENV=production
Environment=PORT=4321
Environment=HOST=0.0.0.0
ExecStart=/usr/bin/node dist/server/entry.mjs
Restart=always
RestartSec=10
StandardOutput=append:/var/www/vietnam-moto-auto/frontend/logs/frontend.log
StandardError=append:/var/www/vietnam-moto-auto/frontend/logs/frontend-error.log

[Install]
WantedBy=multi-user.target
```

### Nginx配置

**⚠️ 生产环境配置（域名+SSL）**：

```nginx
# HTTP重定向到HTTPS
server {
    listen 80;
    server_name vietmoto.top;
    return 301 https://$server_name$request_uri;
}

# HTTPS主配置
server {
    listen 443 ssl http2;
    server_name vietmoto.top;
    
    # SSL证书配置
    ssl_certificate /etc/letsencrypt/live/vietmoto.top/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/vietmoto.top/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    
    # 安全头
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css application/json application/javascript text/xml;
    
    # Astro SSR 前端（主要入口）
    location / {
        proxy_pass http://127.0.0.1:4321;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # API 代理到后端（关键配置）
    location /api/ {
        proxy_pass http://127.0.0.1:4001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
    }
}
```

**配置说明**：
1. **SSL证书**：使用Let's Encrypt自动续期
2. **HTTPS强制**：HTTP自动重定向到HTTPS
3. **前端SSR**：所有请求先由Astro SSR处理
4. **API代理**：`/api/` 请求代理到后端4001端口
5. **安全头**：HSTS、X-Frame-Options等
6. **性能优化**：Gzip压缩、HTTP/2

**请求流程**：
```
用户浏览器 (HTTPS)
  ↓
https://vietmoto.top/api/marketplace
  ↓
Nginx (443端口，SSL加密)
  ↓
proxy_pass (内网转发)
  ↓
http://127.0.0.1:4001/api/marketplace (后端HTTP，内网)
  ↓
SQLite数据库 (本地文件)
```

### 快速部署脚本

#### quick-deploy.sh

```bash
#!/bin/bash

# 前端部署
if [ "$1" = "frontend" ]; then
    cd /root/越南摩托汽车网站/frontend
    npm run build
    cp -r dist /var/www/vietnam-moto-auto/frontend/
    systemctl restart vietnam-moto-frontend
    echo "✅ 前端部署完成"
fi

# 后端部署
if [ "$1" = "backend" ]; then
    cd /root/越南摩托汽车网站/backend
    npm run build
    cp -r dist /var/www/vietnam-moto-auto/backend/
    systemctl restart vietnam-moto-backend
    echo "✅ 后端部署完成"
fi
```

---

## API接口文档

### 1. 获取车辆列表（支持类型筛选）

**请求**

**开发环境**：
```bash
curl http://localhost:4001/api/marketplace?vehicle_type=moto-gas&page=1&limit=12
```

**生产环境（域名+SSL）**：
```bash
# 通过域名访问（推荐）
curl https://vietmoto.top/api/marketplace?vehicle_type=moto-gas&page=1&limit=12

# 前端调用（使用相对路径）
GET /api/marketplace?vehicle_type=moto-gas&page=1&limit=12
```

**参数**
| 参数 | 类型 | 必填 | 说明 | 示例值 |
|------|------|------|------|--------|
| vehicle_type | string | 否 | 车辆类型筛选 | moto-gas, moto-electric, car-gas, car-electric |
| page | number | 否 | 页码 | 1 |
| limit | number | 否 | 每页数量 | 12 |
| brand | string | 否 | 品牌筛选 | Honda |
| minPrice | number | 否 | 最低价格 | 10000000 |
| maxPrice | number | 否 | 最高价格 | 50000000 |
| city | string | 否 | 城市筛选 | Hà Nội |
| sort | string | 否 | 排序方式 | year_desc, year_asc, price_asc, price_desc, popular, latest |

**响应**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "external_id": "171265324",
      "type": "motorcycle",
      "vehicle_type": "moto-gas",
      "brand": "Yamaha",
      "year": 2013,
      "price": 25900000,
      "title": "Yamaha Exciter 135cc",
      "mileage": 2000,
      "condition_text": "Đã sử dụng",
      "image_url": "https://cdn.chotot.com/...",
      "city": "Đà Nẵng",
      "district": "Quận Thanh Khê",
      "seller_name": "Nguyễn Văn A",
      "seller_rating": 4.5,
      "published_at": "2025-10-13T10:00:00.000Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 12,
    "total": 50,
    "totalPages": 5
  }
}
```

### 2. 获取车辆详情

**请求**

**生产环境（域名+SSL）**：
```bash
# 通过域名访问
curl https://vietmoto.top/api/marketplace/123

# 前端调用（相对路径）
GET /api/marketplace/123
```

**响应**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "vehicle_type": "moto-gas",
    "title": "Yamaha Exciter 135cc",
    "price": 25900000,
    "description": "Xe đẹp, máy zin...",
    "images": ["url1", "url2", "url3"],
    "external_url": "https://xe.chotot.com/171265324",
    "seller_phone": "0901234567",
    "view_count": 15
  }
}
```

### 3. 手动同步数据（全量）

**请求**

**生产环境（域名+SSL）**：
```bash
# 通过域名访问
curl -X POST https://vietmoto.top/api/marketplace/sync

# 内网直接访问（服务器本地）
curl -X POST http://localhost:4001/api/marketplace/sync
```

**响应**
```json
{
  "success": true,
  "message": "Data sync completed",
  "data": {
    "moto-gas": { "fetched": 50, "saved": 48 },
    "moto-electric": { "fetched": 50, "saved": 50 },
    "car-gas": { "fetched": 50, "saved": 45 },
    "car-electric": { "fetched": 50, "saved": 50 }
  }
}
```

### 4. 重新分类现有数据

**请求**

**生产环境（域名+SSL）**：
```bash
# 通过域名访问
curl -X POST https://vietmoto.top/api/marketplace/reclassify

# 内网直接访问
curl -X POST http://localhost:4001/api/marketplace/reclassify
```

**功能**
- 对现有数据进行智能重新分类
- 从标题中提取年份信息
- 基于关键词判断燃油/电动类型

**响应**
```json
{
  "success": true,
  "message": "Data reclassification completed",
  "data": {
    "processed": 200,
    "updated": 136
  }
}
```

### 5. 获取统计信息

**请求**

**生产环境（域名+SSL）**：
```bash
# 通过域名访问
curl https://vietmoto.top/api/marketplace/stats/summary

# 前端调用（相对路径）
GET /api/marketplace/stats/summary
```

**响应**
```json
{
  "success": true,
  "data": {
    "total": 193,
    "brands": 15,
    "cities": 20,
    "avgPrice": 35000000,
    "minPrice": 5000000,
    "maxPrice": 150000000
  }
}
```

---

## 数据同步机制

### 自动同步流程

```
┌─────────────────────────────────────────────────────────────┐
│                    定时任务触发                               │
│                  (每天凌晨2点)                                │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│              MarketplaceScheduler.runSync()                  │
│              - 检查是否正在运行                               │
│              - 设置运行标志                                   │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│           ChoTotService.fetchAndSaveAll(50)                  │
│           循环处理4种类型:                                    │
│           1. moto-gas    (燃油摩托车)                        │
│           2. moto-electric (电动摩托车)                      │
│           3. car-gas     (燃油汽车)                          │
│           4. car-electric (电动汽车)                         │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│          每种类型执行:                                        │
│          ChoTotService.fetchVehicles(type, 50)               │
│          - 请求API获取150条数据                               │
│          - 过滤最近3周的数据                                  │
│          - 返回前50条                                         │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│          ChoTotService.saveToDatabase(ads, type)             │
│          - 遍历每条数据                                       │
│          - 转换数据格式 (包含vehicle_type)                    │
│          - upsert到数据库                                     │
│          - 延迟500ms避免过快                                  │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                   同步完成                                    │
│                   - 记录日志                                  │
│                   - 输出统计信息                              │
│                   - 清除运行标志                              │
└─────────────────────────────────────────────────────────────┘
```

### 同步策略

#### 定时任务
- **频率**: 每天凌晨2点执行
- **数量**: 每种类型50条，总计200条
- **Cron表达式**: `0 2 * * *`

#### 数据分布
| 车辆类型 | 每次同步数量 | Chợ Tốt分类ID |
|---------|-------------|--------------|
| moto-gas (燃油摩托车) | 50 | 2020 |
| moto-electric (电动摩托车) | 50 | 2020 |
| car-gas (燃油汽车) | 50 | 2010 |
| car-electric (电动汽车) | 50 | 2010 |
| **总计** | **200** | - |

### 手动同步

#### 方法1: API调用
```bash
curl -X POST http://localhost:4001/api/marketplace/sync
```

#### 方法2: 命令行脚本
```bash
cd /var/www/vietnam-moto-auto/backend
node -e "
const ChoTotService = require('./dist/services/ChoTotService').default;
(async () => {
  const results = await ChoTotService.fetchAndSaveAll(50);
  console.log('同步完成:', results);
})();
"
```

### 数据清理策略

#### 清理旧数据（超过3周）
```sql
DELETE FROM marketplace_vehicles 
WHERE published_at < datetime('now', '-21 days');
```

#### 清理无效数据
```sql
DELETE FROM marketplace_vehicles 
WHERE status = 'inactive';
```

---

## 注意事项

### 1. 电话信息限制

**问题**: Chợ Tốt的公开API不提供卖家电话信息

**解决方案**:
- 提供"联系卖家"按钮
- 跳转到Chợ Tốt原始页面
- 用户在原平台查看电话并联系

**实现**:
```astro
<div class="contact-seller-section">
  <a href={vehicle.external_url} target="_blank" class="btn-contact-seller">
    📞 Liên hệ người bán
  </a>
  <p>Nhấn để xem số điện thoại và liên hệ trực tiếp</p>
</div>
```

### 2. vehicle_type 字段的重要性

**作用**: 
- 区分4种车辆类型的核心字段
- 前端筛选标签的数据源
- 支持精准的数据展示

**必须正确设置**:
```typescript
const vehicleType = 'moto-gas'; // 或 moto-electric, car-gas, car-electric
await MarketplaceVehicle.upsert({
  vehicle_type: vehicleType, // 必须设置
  // ...
});
```

### 3. 前端API调用配置

**问题**: Mixed Content错误（域名+SSL环境）

**错误信息**:
```
Mixed Content: The page at 'https://vietmoto.top/marketplace' was loaded over HTTPS, 
but requested an insecure XMLHttpRequest endpoint 'http://47.237.79.9:4001/api/marketplace'
```

**原因**: 
- 前端硬编码了HTTP地址
- 使用了`.env.production`配置HTTP API地址

**解决方案**:
```typescript
// ❌ 错误写法
const API_BASE_URL = 'http://47.237.79.9:4001/api';
const API_BASE_URL = import.meta.env.PUBLIC_API_URL || 'http://...';

// ✅ 正确写法（域名+SSL环境）
const API_BASE_URL = '/api';  // 相对路径，自动通过Nginx代理
```

**重要提醒**:
- 🚫 删除所有 `.env.production` 文件
- ✅ 使用相对路径 `/api`
- ✅ Nginx自动代理到后端HTTP
- ✅ 浏览器看到的都是HTTPS

### 4. CSS文件导入

**问题**: 组件样式不生效

**原因**: 忘记导入CSS文件

**解决**:
```typescript
// MarketplaceList.tsx
import './MarketplaceList.css'; // 必须导入！
```

### 5. 服务器代理问题

**问题**: 服务器配置了HTTP代理，导致API请求失败

**错误信息**:
```
connect ECONNREFUSED 127.0.0.1:7890
```

**解决方案**:
```bash
# 清除代理环境变量
env -u http_proxy -u https_proxy node dist/index.js

# 或在systemd服务中配置
Environment="NO_PROXY=*"
```

### 6. 数据时效性

**策略**: 只保留最近3周的数据

**原因**:
- 二手交易信息时效性强
- 避免展示已售出的车辆
- 减少数据库存储压力

### 7. 响应式设计

**筛选标签布局**:
- 桌面 (>968px): 4列
- 平板 (480-968px): 2列
- 手机 (<480px): 1列

**实现**:
```css
.vehicle-tabs {
  grid-template-columns: repeat(4, 1fr); /* 默认4列 */
}

@media (max-width: 968px) {
  .vehicle-tabs {
    grid-template-columns: repeat(2, 1fr); /* 平板2列 */
  }
}

@media (max-width: 480px) {
  .vehicle-tabs {
    grid-template-columns: 1fr; /* 手机1列 */
  }
}
```

### 8. 毛玻璃效果兼容性

**backdrop-filter 支持**:
- 现代浏览器: ✅ 完全支持
- Safari: ✅ 需要 -webkit- 前缀
- 老旧浏览器: ⚠️ 降级为纯色背景

**实现**:
```css
.tab-button {
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px); /* Safari */
}
```

### 9. 性能优化

**图片懒加载**:
```tsx
<img 
  src={vehicle.image_url} 
  alt={vehicle.title}
  loading="lazy" // 懒加载
/>
```

**分页加载**:
- 每页12条数据
- 避免一次性加载大量数据
- 提升首屏加载速度

### 10. SEO优化

**列表页预渲染**:
```astro
---
export const prerender = true; // 静态预渲染
---
```

**详情页SSR**:
```astro
---
export const prerender = false; // 服务端渲染
const vehicle = await fetchVehicleData(id);
---
<title>{vehicle.title} - Vietnam Moto & Auto</title>
```

### 11. 数据库维护

**定期维护任务**:
```bash
# 1. 清理旧数据
sqlite3 vietnam_moto_auto.sqlite "
DELETE FROM marketplace_vehicles 
WHERE published_at < datetime('now', '-21 days');
"

# 2. 优化数据库
sqlite3 vietnam_moto_auto.sqlite "VACUUM;"

# 3. 分析查询性能
sqlite3 vietnam_moto_auto.sqlite "ANALYZE;"
```

---

## 总结

### 已实现功能

#### 数据采集与管理
- ✅ 自动抓取Chợ Tốt二手车辆数据
- ✅ 支持4种车辆类型的独立抓取
- ✅ **智能分类系统**：基于关键词自动识别燃油/电动车辆
- ✅ **年份提取功能**：从标题中智能提取车辆年份
- ✅ 只保留最近3周的新鲜数据
- ✅ 每日自动同步数据（每种类型50条）
- ✅ 手动同步API
- ✅ **数据重新分类API**：支持对现有数据进行智能重新分类

#### 前端展示
- ✅ 车辆列表展示和分页（每页12条）
- ✅ **四种类型筛选标签**（燃油摩托车、电动摩托车、燃油汽车、电动汽车）
- ✅ **现代化毛玻璃UI设计**
- ✅ **按年份排序**：支持最新/最旧年份排序
- ✅ 车辆详情页（SSR渲染）
- ✅ 联系卖家功能（跳转原平台）
- ✅ 响应式布局（桌面/平板/手机）

#### API接口
- ✅ 获取车辆列表（支持vehicle_type筛选和年份排序）
- ✅ 获取车辆详情
- ✅ 手动同步数据
- ✅ **数据重新分类API**
- ✅ 统计信息查询

### 技术特点

#### 前端技术
- **Astro混合渲染**: 列表页静态，详情页动态
- **React组件**: 交互式筛选和分页
- **Cursor风格设计**: 毛玻璃、渐变、立体感
- **响应式布局**: 自适应各种屏幕尺寸
- **性能优化**: 懒加载、分页加载

#### 后端技术
- **多类型支持**: 4种车辆类型独立管理
- **智能分类**: 基于关键词自动识别燃油/电动车辆
- **年份提取**: 从标题中智能提取车辆年份信息
- **数据时效**: 3周内数据，确保新鲜度
- **智能去重**: upsert机制避免重复
- **定时同步**: 每日自动更新
- **数据重新分类**: 支持对现有数据进行智能重新分类
- **API优化**: 合理的查询和索引，支持年份排序

### 数据统计

| 指标 | 数值 |
|------|------|
| 支持车辆类型 | 4种 |
| 每种类型数据量 | 50条 |
| 总数据量 | ~200条 |
| 数据更新频率 | 每天一次 |
| 数据时效性 | 最近3周 |
| 每页展示数量 | 12条 |

### 未来优化方向

#### 功能扩展
- [ ] 高级搜索和筛选（价格区间、年份、品牌）
- [ ] 收藏和对比功能
- [ ] 价格趋势分析图表
- [ ] 用户评论和点评系统
- [ ] 消息通知系统

#### 数据源扩展
- [ ] 集成更多二手交易平台
- [ ] 支持更多车辆品牌
- [ ] 添加新车价格对比

#### UI/UX优化
- [ ] 添加筛选器动画效果
- [ ] 优化加载状态展示
- [ ] 添加数据可视化图表
- [ ] 支持深色模式切换

#### 性能优化
- [ ] 实现服务端缓存
- [ ] 添加CDN支持
- [ ] 优化图片加载策略
- [ ] 实现虚拟滚动

---

## 更新日志

### v1.2 (2025-10-14)
**生产环境：域名+SSL部署更新**
- ✅ 更新Nginx配置：完整的HTTPS + SSL配置示例
- ✅ 更新API调用规范：强调使用相对路径 `/api`
- ✅ 添加Mixed Content错误解决方案
- ✅ 更新API接口文档：所有示例使用HTTPS域名
- ✅ 添加前端API调用最佳实践
- ✅ 更新注意事项：新增前端API调用配置说明
- ✅ 强调不要使用 `.env.production` 配置API地址
- ✅ 添加完整的请求流程图（HTTPS环境）

### v1.1 (2025-10-13)
- ✅ **智能分类系统**：基于关键词自动识别燃油/电动车辆
- ✅ **年份提取功能**：从标题中智能提取车辆年份信息
- ✅ **按年份排序**：支持最新/最旧年份排序
- ✅ **数据重新分类API**：支持对现有数据进行智能重新分类
- ✅ 修复汽车数据年份排序问题
- ✅ 优化排序逻辑，年份为空时按发布时间排序

### v1.0 (2025-10-13)
- ✅ 初始版本发布
- ✅ 实现4种车辆类型筛选
- ✅ 现代化毛玻璃UI设计
- ✅ 完整的数据同步机制
- ✅ 响应式布局支持

---

## 联系方式

如有问题或建议，请联系开发团队。

**文档版本**: v1.2（生产环境 - 域名+SSL）  
**最后更新**: 2025-10-14  
**维护者**: Vietnam Moto & Auto 开发团队  
**生产环境**: https://vietmoto.top/marketplace

